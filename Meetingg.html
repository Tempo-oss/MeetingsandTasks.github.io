<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetingMate - Collaborative Meeting Tool</title>
    
    <!-- Robust Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="background-color: #FEF2F2; color: #991B1B; padding: 2rem; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Application Error</h2>
                        <div style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #FCA5A5; text-align: left; max-width: 600px; overflow-x: auto;">
                            <p style="font-weight:bold; margin-bottom:0.5rem">${msg}</p>
                            <p style="font-size:0.8rem">Line: ${line} | Col: ${col}</p>
                        </div>
                    </div>
                `;
            }
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden">
    <!-- Initial Loading State -->
    <div id="root" class="h-full flex items-center justify-center">
        <div class="text-center text-gray-500 animate-pulse">
            <p>Loading MeetingMate...</p>
        </div>
    </div>

    <script type="text/babel">
        // Dependency Check
        if (!window.React || !window.ReactDOM || !window.supabase) {
            throw new Error("Missing dependencies. Check internet connection.");
        }

        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuration ---
        const SUPABASE_URL = 'https://yasoowbpyknuikdvlahz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_7upkUKZm8t5fQh9EwLVFbQ_DmnLAObn';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error("Supabase Init Error:", e);
            throw new Error("Failed to initialize Supabase client.");
        }

        // --- Utils ---
        const getTodayISO = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };

        const calculateDaysRemaining = (endDate) => {
            if (!endDate) return null;
            const end = new Date(endDate);
            const today = new Date();
            end.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            const diffTime = end - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        // --- PARTICIPANT CHECK HELPER (CRITICAL FOR VISIBILITY) ---
        const isUserParticipant = (meeting, user) => {
            if (!meeting || !user) return false;
            const parts = meeting.participants || [];
            if (!Array.isArray(parts)) return false;
            
            const userEmail = (user.email || '').toLowerCase().trim();
            const userId = user.id;

            return parts.some(p => {
                // Handle different data shapes
                let pId, pEmail;
                if (typeof p === 'string') {
                    pId = p;
                    pEmail = p;
                } else if (typeof p === 'object' && p !== null) {
                    pId = p.id;
                    pEmail = p.email;
                } else {
                    return false;
                }
                
                // 1. Check UUID match
                if (pId === userId) return true;
                
                // 2. Check Email match (Robust)
                if (pEmail && typeof pEmail === 'string' && pEmail.toLowerCase().trim() === userEmail) return true;
                // Some older data might have email in the ID field
                if (typeof pId === 'string' && pId.toLowerCase().trim() === userEmail) return true;
                
                return false;
            });
        };

        const DEPARTMENTS = ['Managers', 'Leaders', 'Quality', 'Training', 'HR', 'Mentors', 'WFM', 'Eng team'];
        const ADMIN_EMAILS = ['mohamed.abdelmagid@tempo.fit', 'halim@tempo.fit', 'nancy@tempo.fit'];

        // --- Icons ---
        const Icon = ({ name, className, ...props }) => {
            const icons = {
                Calendar: <path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm-13 0V2m12 2V2M3 10h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Clock: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm0-14v6l4 2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Video: <path d="m22 8-6 4 6 4V8Z M16 19h-4m-4 0H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Search: <path d="m21 21-4.3-4.3 M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Plus: <path d="M12 5v14M5 12h14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                ChevronLeft: <path d="m15 18-6-6 6-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8 M21 3v5h-5 M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16 M3 21v-5h5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Database: <path d="M3 5V19A9 3 0 0 0 21 19V5 M3 5A9 3 0 0 1 21 5 M3 5A9 3 0 0 0 21 5 M3 12A9 3 0 0 0 21 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                UploadCloud: <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242 M12 12v9 M16 16l-4-4-4 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Trash2: <path d="M3 6h18 M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6 M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2 M10 11v6 M14 11v6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                AlertCircle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9h2m-2 4h2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                CheckSquare: <path d="m9 11 3 3L22 4 M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                FileText: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M14 2v6h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Bold: <path d="M14 12a4 4 0 0 0 0-8H6v8 M15 20a4 4 0 0 0 0-8H6v8Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Italic: <path d="M19 4h-9M14 20H5M15 4L9 20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Underline: <path d="M6 4v6a6 6 0 0 0 12 0V4 M4 20h16" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Share2: <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Circle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                CheckCircle2: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9 2 2 4-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                X: <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                ExternalLink: <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Google: <g><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M24 12c0-.82-.07-1.63-.2-2.43H12v4.6h6.77c-.29 1.55-1.16 2.87-2.48 3.75l.02-.02 3.55 2.75c2.08-1.91 3.28-4.73 3.28-8.22z" fill="#4285F4"/></g>,
                Mail: <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6l-10 7L2 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                UserPlus: <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M8.5 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z M20 8v6M23 11h-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                FileText: <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z M14 3v5h5 M16 13H8 M16 17H8 M10 9H8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                PieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83 M22 12A10 10 0 0 0 12 2v10z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Crown: <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Briefcase: <path d="M20 7h-3a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z M9 7V5h6v2 M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Hash: <path d="M4 9h16 M4 15h16 M10 3L8 21 M16 3l-2 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Layers: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></g>,
                Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Filter: <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                XCircle: <path d="M22 12A10 10 0 1 1 12 2a10 10 0 0 1 0 20zM15 9l-6 6M9 9l6 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="24" height="24" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    className={className}
                    {...props}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/>}
                </svg>
            );
        };

        const SQL_SETUP_INSTRUCTIONS = `
-- Run these commands in your Supabase SQL Editor:

create table if not exists meetings (
    id text primary key,
    title text,
    date text,
    time text,
    duration text,
    participants jsonb, 
    doc_id text,
    google_calendar_id text,
    synced boolean,
    platform text,
    google_doc_link text
);

create table if not exists tasks (
    id text primary key,
    meeting_id text,
    text text,
    assignee text,
    done boolean,
    status text default 'pending',
    obstacles text,
    start_date date,
    end_date date
);

create table if not exists team_members (
    email text primary key,
    name text,
    team text,
    role text,
    managed_teams text[],
    system_role text default 'user',
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create table if not exists pending_emails (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    recipient_email text NOT NULL,
    subject text NOT NULL,
    body text NOT NULL,
    status text DEFAULT 'pending',
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'team_members' AND column_name = 'team') THEN
        ALTER TABLE team_members ADD COLUMN team text;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'team_members' AND column_name = 'role') THEN
        ALTER TABLE team_members ADD COLUMN role text;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'team_members' AND column_name = 'managed_teams') THEN
        ALTER TABLE team_members ADD COLUMN managed_teams text[];
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'team_members' AND column_name = 'system_role') THEN
        ALTER TABLE team_members ADD COLUMN system_role text DEFAULT 'user';
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'tasks' AND column_name = 'start_date') THEN
        ALTER TABLE tasks ADD COLUMN start_date date;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'tasks' AND column_name = 'end_date') THEN
        ALTER TABLE tasks ADD COLUMN end_date date;
    END IF;
END $$;
        `;

        // --- Components ---

        const UserAvatar = ({ user, size = 'md' }) => {
            const sizeClasses = { sm: 'w-6 h-6 text-xs', md: 'w-8 h-8 text-sm', lg: 'w-10 h-10 text-base' };
            if (!user) return null;
            const name = user.name || user.email || 'Unknown';
            const initial = name.substring(0,2).toUpperCase();
            return (
                <div className={`${sizeClasses[size]} bg-indigo-600 rounded-full flex items-center justify-center text-white font-medium ring-2 ring-white select-none uppercase`} title={name}>
                    {initial}
                </div>
            );
        };

        const AppHeader = ({ currentUser, onLogout, onClear, onSync, dbStatus, onBack, title, isSyncing, syncRange, setSyncRange }) => (
            <header className="bg-white border-b h-16 flex items-center justify-between px-4 sm:px-6 shrink-0 sticky top-0 z-20">
                <div className="flex items-center space-x-3">
                    {onBack && (
                        <button onClick={onBack} className="p-1.5 hover:bg-gray-100 rounded-full text-gray-500 mr-1 transition-colors">
                            <Icon name="ChevronLeft" className="w-5 h-5" />
                        </button>
                    )}
                    {!onBack && <div className="bg-indigo-600 p-1.5 rounded-lg"><Icon name="Calendar" className="text-white w-5 h-5" /></div>}
                    
                    <div>
                        <h1 className="font-bold text-gray-800 text-lg leading-tight truncate max-w-[150px] sm:max-w-none">{title || 'SyncMeet'}</h1>
                    </div>

                    {dbStatus === 'connected' && <span className="bg-green-100 text-green-700 text-[10px] uppercase font-bold tracking-wide px-2 py-0.5 rounded-full">Live</span>}
                    {dbStatus === 'setup_required' && <span className="bg-red-100 text-red-700 text-[10px] uppercase font-bold tracking-wide px-2 py-0.5 rounded-full">DB Setup</span>}
                </div>
                <div className="flex items-center space-x-3 sm:space-x-4">
                    {onSync && (dbStatus === 'empty' || dbStatus === 'connected') && 
                        <div className="flex items-center space-x-2">
                            <select 
                                value={syncRange}
                                onChange={(e) => setSyncRange(e.target.value)}
                                className="text-xs border-gray-300 rounded border p-1 text-gray-600 focus:outline-none focus:ring-1 focus:ring-indigo-500 hidden sm:block"
                            >
                                <option value="upcoming">Upcoming</option>
                                <option value="past_month">Past 30 Days</option>
                            </select>
                            <button onClick={onSync} disabled={isSyncing} className="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center disabled:opacity-50">
                                <Icon name="RefreshCw" className={`w-4 h-4 mr-1 ${isSyncing ? 'animate-spin' : ''}`}/> 
                                <span className="hidden sm:inline">{isSyncing ? 'Syncing...' : 'Sync'}</span>
                            </button>
                        </div>
                    }
                    <div className="h-6 w-px bg-gray-200 mx-1 hidden sm:block"></div>
                    <div className="flex items-center space-x-2">
                        <UserAvatar user={currentUser} size="sm" />
                        <div className="hidden md:flex flex-col items-start">
                            <span className="text-sm font-medium text-gray-700 truncate max-w-[100px]">{currentUser.name}</span>
                            <span className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">{currentUser.system_role}</span>
                        </div>
                        <button onClick={onLogout} className="bg-white border border-gray-200 text-gray-600 hover:text-red-600 hover:bg-red-50 px-3 py-1.5 rounded-md text-sm font-medium transition-colors shadow-sm ml-2" title="Log Out">
                            Log Out
                        </button>
                    </div>
                </div>
            </header>
        );

        const MeetingCard = ({ meeting, onClick }) => {
            const participants = meeting.participants || [];
            
            return (
                <div onClick={onClick} className="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-lg hover:border-indigo-200 transition-all cursor-pointer group">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <h3 className="font-semibold text-gray-900 group-hover:text-indigo-600 transition-colors">{meeting.title}</h3>
                            <div className="flex items-center text-gray-500 text-sm mt-1 space-x-3">
                                {meeting.date && <span className="flex items-center"><Icon name="Calendar" className="w-3 h-3 mr-1" /> {meeting.date}</span>}
                                {meeting.time && <span className="flex items-center"><Icon name="Clock" className="w-3 h-3 mr-1" /> {meeting.time}</span>}
                            </div>
                        </div>
                        <div className="flex items-center space-x-2">
                            {meeting.google_doc_link && (
                                <a 
                                    href={meeting.google_doc_link} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    onClick={(e) => e.stopPropagation()} 
                                    className="bg-blue-50 text-blue-600 p-1.5 rounded-full hover:bg-blue-100 transition-colors"
                                    title="Open Google Doc"
                                >
                                    <Icon name="FileText" className="w-4 h-4" />
                                </a>
                            )}
                            {meeting.synced && <div className="bg-gray-100 text-gray-600 p-1.5 rounded-full"><Icon name="Calendar" className="w-4 h-4" /></div>}
                        </div>
                    </div>
                    <div className="flex justify-between items-center mt-4">
                        <div className="flex -space-x-2">
                            {participants.slice(0,4).map((user, i) => <UserAvatar key={i} user={user} size="sm" />)}
                            {participants.length > 4 && <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px] ring-2 ring-white">+{participants.length - 4}</div>}
                        </div>
                        <div className="flex items-center text-gray-400 text-sm space-x-1 group-hover:text-indigo-500 transition-colors">
                            <span>Open Tasks</span>
                            <Icon name="ChevronLeft" className="w-4 h-4 rotate-180" />
                        </div>
                    </div>
                </div>
            );
        };

        const TaskCard = ({ task, meetingTitle, onStatusChange, onObstacleChange }) => {
            const currentStatus = task.status || (task.done ? 'completed' : 'pending');
            const daysRemaining = calculateDaysRemaining(task.end_date);
            const isOverdue = daysRemaining !== null && daysRemaining < 0 && currentStatus !== 'completed';
            
            return (
                <div className="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow">
                    <div className="flex items-start space-x-3 mb-2">
                        <select
                            value={currentStatus}
                            onChange={(e) => onStatusChange(task.id, e.target.value)}
                            className={`text-xs font-bold uppercase tracking-wider px-2 py-1 rounded border cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                currentStatus === 'completed' 
                                ? 'bg-green-100 text-green-800 border-green-200' 
                                : 'bg-yellow-100 text-yellow-800 border-yellow-200'
                            }`}
                        >
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                        </select>
                        
                        <div className="flex-1">
                            <p className={`text-sm font-medium text-gray-900 ${currentStatus === 'completed' ? 'line-through text-gray-500' : ''}`}>
                                {task.text}
                            </p>
                            <div className="flex flex-col sm:flex-row sm:items-center mt-1 text-xs text-gray-500 gap-1 sm:gap-3">
                                <span>From: {meetingTitle}</span>
                                {task.assigneeName && <span className="text-indigo-600">â€¢ Assigned to: {task.assigneeName}</span>}
                                {task.start_date && <span>â€¢ Start: {task.start_date}</span>}
                                {task.end_date && <span>â€¢ Due: {task.end_date}</span>}
                            </div>
                            
                            {/* Deadline Counter */}
                            {task.end_date && currentStatus !== 'completed' && (
                                <div className="mt-1">
                                    {isOverdue ? (
                                        <span className="text-[10px] font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded-full border border-red-100">
                                            Overdue by {Math.abs(daysRemaining)} days
                                        </span>
                                    ) : (
                                        <span className="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded-full border border-green-100">
                                            {daysRemaining} days left
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="mt-3 pt-3 border-t border-gray-100">
                        <div className="flex items-center text-xs text-gray-500 font-semibold mb-1">
                            <Icon name="AlertTriangle" className="w-3 h-3 mr-1 text-orange-400" />
                            Obstacles / Notes
                        </div>
                        <textarea
                            className="w-full text-xs p-2 border border-gray-200 rounded bg-gray-50 focus:bg-white focus:ring-1 focus:ring-indigo-500 outline-none resize-y"
                            rows="2"
                            placeholder="Mention any obstacles faced here..."
                            value={task.obstacles || ''}
                            onChange={(e) => onObstacleChange(task.id, e.target.value)}
                        />
                    </div>
                </div>
            );
        };

        const ReportsView = ({ meetings, tasks, attendees }) => {
            // -- FILTERS STATE --
            const [filterOwner, setFilterOwner] = useState('all');
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterDate, setFilterDate] = useState('');

            // Extract Unique Options
            const uniqueOwners = useMemo(() => {
                const ownerIds = new Set(tasks.map(t => t.assignee));
                const owners = [];
                // Find user details for each ID/email in tasks
                ownerIds.forEach(id => {
                   const user = attendees.find(u => u.email === id || u.id === id);
                   if (user) owners.push(user);
                   else owners.push({ id, name: id, email: id }); // Fallback
                });
                // Deduplicate by email/id
                const unique = new Map();
                owners.forEach(o => unique.set(o.email || o.id, o));
                return Array.from(unique.values());
            }, [tasks, attendees]);

            const uniqueMeetingTitles = useMemo(() => {
                const titles = new Set(meetings.map(m => m.title));
                return Array.from(titles).sort();
            }, [meetings]);

            // Group meetings by title
            const meetingsByTitle = useMemo(() => {
                const groups = {};
                meetings.forEach(m => {
                    const t = m.title || '(No Title)';
                    if (!groups[t]) groups[t] = [];
                    groups[t].push(m);
                });
                return groups;
            }, [meetings]);

            // Filter Logic
            const reportData = useMemo(() => {
                const data = [];
                
                Object.keys(meetingsByTitle).forEach(title => {
                     // NO MEETING FILTER

                    let meetingInstances = meetingsByTitle[title];

                    // 2. Date Filter
                    if (filterDate) {
                        meetingInstances = meetingInstances.filter(m => m.date === filterDate);
                    }
                    
                    if (meetingInstances.length === 0) return;

                    // Gather all task IDs associated with these meeting instances
                    const instanceIds = meetingInstances.map(m => m.id);
                    const relevantTasks = tasks.filter(t => instanceIds.includes(t.meetingId));

                    if (relevantTasks.length === 0) return;

                    const tasksByOwner = {};
                    let hasVisibleTasks = false;

                    relevantTasks.forEach(task => {
                        // 3. Owner Filter
                        if (filterOwner !== 'all') {
                             const matchesId = task.assignee === filterOwner;
                             const matchesEmail = (attendees.find(u => u.id === filterOwner)?.email === task.assignee);
                             if (!matchesId && !matchesEmail) return;
                        }

                        // 4. Status Filter
                        const status = task.status || (task.done ? 'completed' : 'pending');
                        if (filterStatus !== 'all' && status !== filterStatus) return;

                        hasVisibleTasks = true;

                        const ownerId = task.assignee || 'Unassigned';
                        if (!tasksByOwner[ownerId]) {
                            const owner = attendees.find(u => (u.email === ownerId || u.id === ownerId)) || { name: 'Unknown', email: ownerId };
                            tasksByOwner[ownerId] = {
                                owner,
                                tasks: [],
                                pendingCount: 0,
                                completedCount: 0
                            };
                        }
                        
                        tasksByOwner[ownerId].tasks.push(task);
                        if (status === 'completed') {
                            tasksByOwner[ownerId].completedCount++;
                        } else {
                            tasksByOwner[ownerId].pendingCount++;
                        }
                    });

                    if (hasVisibleTasks) {
                         data.push({
                            title,
                            owners: Object.values(tasksByOwner)
                        });
                    }
                });
                return data;
            }, [meetingsByTitle, tasks, attendees, filterOwner, filterStatus, filterDate]);

            // Clear Filters Handler
            const clearFilters = () => {
                setFilterOwner('all');
                setFilterStatus('all');
                setFilterDate('');
            };

            return (
                <div className="space-y-6">
                    {/* FILTER BAR */}
                    <div className="bg-white p-4 rounded-xl border border-gray-200 flex flex-wrap gap-4 items-end shadow-sm">
                        <div className="flex flex-col gap-1 w-full sm:w-auto flex-1 min-w-[150px]">
                            <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Owner</label>
                            <select 
                                value={filterOwner} 
                                onChange={(e) => setFilterOwner(e.target.value)}
                                className="text-sm border-gray-300 rounded-md shadow-sm border p-2 w-full focus:ring-2 focus:ring-indigo-500 outline-none"
                            >
                                <option value="all">All Owners</option>
                                {uniqueOwners.map(u => (
                                    <option key={u.id || u.email} value={u.id || u.email}>{u.name || u.email}</option>
                                ))}
                            </select>
                        </div>

                        <div className="flex flex-col gap-1 w-full sm:w-auto w-[120px]">
                            <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Status</label>
                            <select 
                                value={filterStatus} 
                                onChange={(e) => setFilterStatus(e.target.value)}
                                className="text-sm border-gray-300 rounded-md shadow-sm border p-2 w-full focus:ring-2 focus:ring-indigo-500 outline-none"
                            >
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>

                         <div className="flex flex-col gap-1 w-full sm:w-auto">
                            <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Date</label>
                            <input 
                                type="date"
                                value={filterDate}
                                onChange={(e) => setFilterDate(e.target.value)}
                                className="text-sm border-gray-300 rounded-md shadow-sm border p-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                            />
                        </div>

                        <button 
                            onClick={clearFilters}
                            className="text-sm text-red-600 hover:bg-red-50 px-3 py-2 rounded-md transition-colors flex items-center mb-[1px]"
                            title="Reset all filters"
                        >
                            <Icon name="XCircle" className="w-4 h-4 mr-1" />
                            Clear
                        </button>
                    </div>

                    {/* REPORT LIST */}
                    {reportData.length === 0 ? (
                        <div className="text-center py-12 text-gray-500 bg-white rounded-xl border border-dashed border-gray-300">
                            No tasks found matching your filters.
                        </div>
                    ) : (
                        <div className="space-y-8">
                            {reportData.map(({ title, owners }) => (
                                <div key={title} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                    <div className="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                        <h3 className="font-bold text-gray-800 flex items-center">
                                            <Icon name="Calendar" className="w-4 h-4 mr-2 text-indigo-600" />
                                            {title}
                                        </h3>
                                        {filterDate ? <span className="text-xs text-gray-500">{filterDate}</span> : <span className="text-xs text-gray-500">Aggregate Report</span>}
                                    </div>
                                    <div className="divide-y divide-gray-100">
                                        {owners.map(({ owner, tasks, pendingCount, completedCount }) => (
                                            <div key={owner.email || owner.id} className="p-4">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="flex items-center space-x-2">
                                                        <UserAvatar user={owner} size="sm" />
                                                        <span className="text-sm font-semibold text-gray-800">{owner.name || owner.email}</span>
                                                    </div>
                                                    <div className="flex space-x-2 text-xs">
                                                        <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full font-medium">{pendingCount} Pending</span>
                                                        <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full font-medium">{completedCount} Completed</span>
                                                    </div>
                                                </div>
                                                <div className="pl-10 space-y-2">
                                                    {tasks.map(task => {
                                                        const taskMeeting = meetings.find(m => m.id === task.meetingId);
                                                        const dateLabel = taskMeeting ? taskMeeting.date : (task.start_date || 'No Date');
                                                        
                                                        return (
                                                            <div key={task.id} className="text-sm flex flex-col border-l-2 border-gray-100 pl-3 py-1">
                                                                 <div className="flex justify-between items-start gap-2">
                                                                    <span className={`flex-1 break-words ${(task.status || (task.done?'completed':'pending')) === 'completed' ? 'line-through text-gray-400' : 'text-gray-700'}`}>
                                                                        {task.text}
                                                                    </span>
                                                                    <span className="shrink-0 text-[10px] font-mono text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">
                                                                        {dateLabel}
                                                                    </span>
                                                                </div>
                                                                {task.obstacles && (
                                                                    <span className="ml-0 mt-1 w-fit text-xs text-orange-600 bg-orange-50 px-2 py-0.5 rounded border border-orange-100 max-w-full truncate" title={task.obstacles}>
                                                                        Obstacle: {task.obstacles}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const TeamList = ({ teamMembers, onAddMember, onUpdateMember, onRemoveMember, colleagues }) => {
            const [newEmail, setNewEmail] = useState('');
            const [newName, setNewName] = useState('');
            const [newTeam, setNewTeam] = useState(DEPARTMENTS[0]);
            const [newRole, setNewRole] = useState('Member');
            const [newSystemRole, setNewSystemRole] = useState('user');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!newEmail || !newName) return;
                onAddMember(newEmail, newName, newTeam, newRole, newSystemRole);
                setNewEmail('');
                setNewName('');
            };

            const unassigned = useMemo(() => {
                return colleagues.filter(c => {
                    const existing = teamMembers.find(t => t.email === (c.email || c.id));
                    return !existing || !existing.team || !DEPARTMENTS.includes(existing.team);
                });
            }, [colleagues, teamMembers]);

            const displayUnassigned = unassigned.map(c => {
                const existing = teamMembers.find(t => t.email === (c.email || c.id));
                return existing || c;
            });

            // Handlers for managing teams for managers
            const handleAddManagedTeam = (email, currentManaged, newTeam) => {
                if (!newTeam || currentManaged.includes(newTeam)) return;
                const updated = [...currentManaged, newTeam];
                onUpdateMember(email, { managed_teams: updated });
            };

            const handleRemoveManagedTeam = (email, currentManaged, teamToRemove) => {
                const updated = currentManaged.filter(t => t !== teamToRemove);
                onUpdateMember(email, { managed_teams: updated });
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl border border-gray-200">
                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <Icon name="UserPlus" className="w-5 h-5 mr-2 text-indigo-600" />
                            Add Team Member
                        </h3>
                        <form onSubmit={handleSubmit} className="flex flex-col md:flex-row gap-4">
                            <input
                                type="text"
                                placeholder="Name"
                                value={newName}
                                onChange={(e) => setNewName(e.target.value)}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            />
                            <input
                                type="email"
                                placeholder="Email (@tempo.fit)"
                                value={newEmail}
                                onChange={(e) => setNewEmail(e.target.value)}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            />
                            <select 
                                value={newTeam} 
                                onChange={(e) => setNewTeam(e.target.value)}
                                className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white flex-1"
                            >
                                {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
                            </select>
                            <select 
                                value={newRole} 
                                onChange={(e) => setNewRole(e.target.value)}
                                className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white flex-1"
                            >
                                <option value="Member">Member</option>
                                <option value="Owner">Owner</option>
                            </select>
                            <select 
                                value={newSystemRole} 
                                onChange={(e) => setNewSystemRole(e.target.value)}
                                className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white flex-1"
                                title="System Role: Admin can see everything, User sees only assigned tasks/meetings"
                            >
                                <option value="user">User (Restricted)</option>
                                <option value="admin">Admin (Full Access)</option>
                            </select>
                            <button type="submit" className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                                Add
                            </button>
                        </form>
                    </div>

                    {/* Unassigned / Discovered Section */}
                    {displayUnassigned.length > 0 && (
                        <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                            <div className="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 className="font-bold text-gray-800">Unassigned / Discovered</h3>
                            </div>
                            <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                {displayUnassigned.map(m => {
                                    const email = m.email || m.id;
                                    const inDb = teamMembers.some(tm => tm.email === email);
                                    return (
                                        <div key={email} className="flex flex-col sm:flex-row items-center gap-2 p-2 hover:bg-gray-50 rounded-lg transition-colors border border-gray-100">
                                            <div className="flex items-center space-x-2 flex-1 w-full">
                                                <UserAvatar user={m} size="xs" />
                                                <div className="truncate">
                                                    <p className="text-sm text-gray-800 truncate">{m.name || email}</p>
                                                    <p className="text-[10px] text-gray-500 truncate">{email}</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-1 w-full sm:w-auto items-center">
                                                <select 
                                                    value={m.team || ''}
                                                    onChange={(e) => onUpdateMember(email, { team: e.target.value })}
                                                    className="text-[10px] border-gray-200 rounded p-1 bg-white focus:outline-none w-1/2 sm:w-auto min-w-[80px]"
                                                >
                                                    <option value="">Select Team</option>
                                                    {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
                                                    <option value="">Unassigned</option>
                                                </select>
                                                <select 
                                                    value={m.role || 'Member'}
                                                    onChange={(e) => onUpdateMember(email, { role: e.target.value })}
                                                    className="text-[10px] border-gray-200 rounded p-1 bg-white focus:outline-none w-1/2 sm:w-auto"
                                                >
                                                    <option value="Member">Member</option>
                                                    <option value="Owner">Owner</option>
                                                </select>
                                                {/* Only allow changing system role if member exists in DB, otherwise add first */}
                                                <select 
                                                    value={m.system_role || 'user'}
                                                    onChange={(e) => onUpdateMember(email, { system_role: e.target.value })}
                                                    className="text-[10px] border-gray-200 rounded p-1 bg-white focus:outline-none w-1/2 sm:w-auto"
                                                >
                                                    <option value="user">User</option>
                                                    <option value="admin">Admin</option>
                                                </select>
                                                <button onClick={() => onRemoveMember(email)} className="text-gray-400 hover:text-red-500 p-1" title="Remove from tool">
                                                    <Icon name="Trash2" className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {DEPARTMENTS.map(team => {
                            const members = teamMembers.filter(m => m.team === team);
                            // Owners are: 
                            // 1. Explicit 'Owner' role in this team
                            // 2. OR members of 'Managers' who have this team in their managed_teams list
                            const owners = teamMembers.filter(m => 
                                (m.team === team && m.role === 'Owner') || 
                                (m.team === 'Managers' && m.managed_teams && m.managed_teams.includes(team))
                            );
                            
                            const regularMembers = members.filter(m => m.role !== 'Owner');

                            return (
                                <div key={team} className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm flex flex-col">
                                    <div className="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                        <h3 className="font-bold text-gray-800 flex items-center">
                                            <Icon name="Briefcase" className="w-4 h-4 mr-2 text-indigo-600" />
                                            {team}
                                        </h3>
                                        <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">{members.length}</span>
                                    </div>
                                    <div className="p-4 space-y-4 flex-1">
                                        {/* Owners Section */}
                                        {owners.length > 0 && (
                                            <div className="mb-4">
                                                <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center">
                                                    <Icon name="Crown" className="w-3 h-3 mr-1 text-yellow-500" />
                                                    Team Owner
                                                </h4>
                                                <div className="space-y-2">
                                                    {owners.map(o => (
                                                        <div key={o.email} className="flex flex-col items-start gap-2 bg-yellow-50 p-2 rounded-lg border border-yellow-100">
                                                            <div className="flex items-center space-x-2 w-full">
                                                                <UserAvatar user={o} size="sm" />
                                                                <div className="truncate flex-1">
                                                                    <p className="text-sm font-semibold text-gray-900 truncate">{o.name}</p>
                                                                    <div className="flex items-center gap-1">
                                                                        <p className="text-xs text-gray-500 truncate">{o.email}</p>
                                                                        {o.system_role === 'admin' && <Icon name="Shield" className="w-3 h-3 text-blue-500" title="Admin User"/>}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {o.team === team && (
                                                                <div className="flex gap-1 w-full">
                                                                    <select 
                                                                        value={o.team}
                                                                        onChange={(e) => onUpdateMember(o.email, { team: e.target.value })}
                                                                        className="text-[10px] border border-yellow-200 rounded p-1 bg-white focus:outline-none w-1/2"
                                                                    >
                                                                        {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
                                                                        <option value="">Unassigned</option>
                                                                    </select>
                                                                    <select 
                                                                        value={o.role}
                                                                        onChange={(e) => onUpdateMember(o.email, { role: e.target.value })}
                                                                        className="text-[10px] border border-yellow-200 rounded p-1 bg-white focus:outline-none w-1/2"
                                                                    >
                                                                        <option value="Member">Member</option>
                                                                        <option value="Owner">Owner</option>
                                                                    </select>
                                                                </div>
                                                            )}
                                                            {o.team !== team && (
                                                                <span className="text-[10px] bg-indigo-100 text-indigo-700 px-1 rounded">Via Managers</span>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Members Section */}
                                        <div>
                                            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Members</h4>
                                            <div className="space-y-2">
                                                {regularMembers.length === 0 ? (
                                                    <p className="text-sm text-gray-400 italic">No members yet.</p>
                                                ) : (
                                                    regularMembers.map(m => (
                                                        <div key={m.email} className="flex flex-col gap-2 p-1.5 hover:bg-gray-50 rounded-lg transition-colors border border-transparent hover:border-gray-100">
                                                            <div className="flex items-center space-x-2 w-full">
                                                                <UserAvatar user={m} size="xs" />
                                                                <div className="truncate flex-1">
                                                                    <p className="text-sm text-gray-800 truncate">{m.name}</p>
                                                                    <div className="flex items-center gap-1">
                                                                        <p className="text-[10px] text-gray-500 truncate">{m.email}</p>
                                                                        {m.system_role === 'admin' && <Icon name="Shield" className="w-3 h-3 text-blue-500" title="Admin User"/>}
                                                                    </div>
                                                                </div>
                                                                <button onClick={() => onRemoveMember(m.email)} className="text-gray-400 hover:text-red-500 p-1" title="Remove">
                                                                    <Icon name="Trash2" className="w-3 h-3" />
                                                                </button>
                                                            </div>
                                                            
                                                            <div className="flex gap-1 w-full">
                                                                <select 
                                                                    value={m.team}
                                                                    onChange={(e) => onUpdateMember(m.email, { team: e.target.value })}
                                                                    className="text-[10px] border-gray-200 rounded p-1 bg-white focus:outline-none w-1/2"
                                                                >
                                                                    {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
                                                                    <option value="">Unassigned</option>
                                                                </select>
                                                                <select 
                                                                    value={m.role}
                                                                    onChange={(e) => onUpdateMember(m.email, { role: e.target.value })}
                                                                    className="text-[10px] border-gray-200 rounded p-1 bg-white focus:outline-none w-1/2"
                                                                >
                                                                    <option value="Member">Member</option>
                                                                    <option value="Owner">Owner</option>
                                                                </select>
                                                            </div>
                                                            
                                                            {/* MANAGERS SPECIAL UI: Managed Teams */}
                                                            {m.team === 'Managers' && (
                                                                <div className="w-full pt-1 border-t border-gray-100 mt-1">
                                                                    <p className="text-[10px] font-bold text-gray-400 mb-1">Manages:</p>
                                                                    <div className="flex flex-wrap gap-1 mb-1">
                                                                        {(m.managed_teams || []).map(mt => (
                                                                            <span key={mt} className="text-[9px] bg-green-50 text-green-700 border border-green-100 px-1 rounded flex items-center">
                                                                                {mt}
                                                                                <button onClick={() => handleRemoveManagedTeam(m.email, m.managed_teams, mt)} className="ml-1 hover:text-red-500">Ã—</button>
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                    <select 
                                                                        value="" 
                                                                        onChange={(e) => handleAddManagedTeam(m.email, m.managed_teams || [], e.target.value)}
                                                                        className="text-[10px] w-full border border-gray-200 rounded bg-gray-50"
                                                                    >
                                                                        <option value="">+ Add Team</option>
                                                                        {DEPARTMENTS.filter(d => d !== 'Managers').map(d => <option key={d} value={d}>{d}</option>)}
                                                                    </select>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const TaskManager = ({ tasks, attendees, onUpdateTask, onAdd, meetingId, currentUserId, teamMembers }) => {
            const [newTaskText, setNewTaskText] = useState('');
            const [assignee, setAssignee] = useState(currentUserId || '');
            const [startDate, setStartDate] = useState(getTodayISO());
            const [endDate, setEndDate] = useState(getTodayISO());

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newTaskText.trim()) return;
                const finalAssignee = assignee || currentUserId; 
                onAdd(meetingId, newTaskText, finalAssignee, startDate, endDate);
                setNewTaskText('');
            };

            const handleStatusChange = (taskId, newStatus) => {
                onUpdateTask(taskId, { status: newStatus, done: newStatus === 'completed' });
            };

            const handleObstacleChange = (taskId, newObstacles) => {
                onUpdateTask(taskId, { obstacles: newObstacles });
            };

            const activeTasks = tasks.filter(t => (t.status !== 'completed' && !t.done));
            const completedTasks = tasks.filter(t => (t.status === 'completed' || t.done));

            return (
                <div className="flex flex-col h-full bg-white w-full">
                    <div className="p-6 border-b border-gray-200 bg-white">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center">
                            <Icon name="CheckSquare" className="w-6 h-6 mr-3 text-indigo-600" />
                            Action Items
                        </h2>
                        
                        <form onSubmit={handleAdd} className="mt-4 flex flex-col gap-2">
                            <input 
                                type="text" 
                                placeholder="New task description..." 
                                className="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" 
                                value={newTaskText} 
                                onChange={(e) => setNewTaskText(e.target.value)} 
                            />
                            <div className="flex gap-2">
                                <div className="w-1/3">
                                     <select 
                                        className="w-full text-sm border-gray-300 rounded-md shadow-sm border p-2 bg-white" 
                                        value={assignee} 
                                        onChange={(e) => setAssignee(e.target.value)}
                                    >
                                        <option value={currentUserId}>Me</option>
                                        {/* Consolidate all users: teamMembers + attendees */}
                                        {(() => {
                                            const uniqueUsers = new Map();
                                            if (attendees) attendees.forEach(u => uniqueUsers.set(u.email || u.id, u));
                                            if (teamMembers) teamMembers.forEach(u => uniqueUsers.set(u.email || u.id, u));
                                            
                                            return Array.from(uniqueUsers.values()).map(u => (
                                                <option key={u.email || u.id} value={u.email || u.id}>{u.name || u.email}</option>
                                            ));
                                        })()}
                                    </select>
                                </div>
                                <div className="flex-1 flex gap-2">
                                    <input 
                                        type="date" 
                                        value={startDate} 
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="w-1/2 text-sm border p-2 rounded"
                                        title="Start Date"
                                    />
                                    <input 
                                        type="date" 
                                        value={endDate} 
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="w-1/2 text-sm border p-2 rounded"
                                        title="Due Date"
                                    />
                                </div>
                                <button type="submit" disabled={!newTaskText.trim()} className="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 disabled:opacity-50">
                                    <Icon name="Plus" className="w-5 h-5" />
                                </button>
                            </div>
                        </form>
                    </div>

                    {meetingId && meetingId !== 'standalone' && (
                        <div className="px-6 py-2 flex justify-end">
                             <button 
                                className="text-xs flex items-center text-indigo-600 hover:text-indigo-800 font-medium"
                                onClick={() => {
                                    // Trigger doc import (requires logic in parent)
                                    // For now, this button is just a placeholder or needs to be hooked up
                                    // if passed down.
                                    // Actually, import logic is better placed in meeting details view.
                                }}
                             >
                                <Icon name="Download" className="w-3 h-3 mr-1" />
                                Import from Doc
                            </button>
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50">
                        <div className="space-y-3">
                            <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">To Do</h3>
                            {activeTasks.length === 0 && <p className="text-sm text-gray-400 italic">No open tasks.</p>}
                            {activeTasks.map(task => {
                                // Resolve assignee name from teamMembers primarily
                                const user = (teamMembers || []).find(u => (u.email === task.assignee || u.id === task.assignee)) || 
                                             (attendees || []).find(u => (u.email === task.assignee || u.id === task.assignee)) || 
                                             { name: 'Unknown' };
                                task.assigneeName = user.name || user.email; 
                                return (
                                    <TaskCard 
                                        key={task.id} 
                                        task={task} 
                                        meetingTitle="" 
                                        onStatusChange={handleStatusChange}
                                        onObstacleChange={handleObstacleChange}
                                    />
                                );
                            })}
                        </div>
                        {completedTasks.length > 0 && (
                            <div className="space-y-3 pt-6 border-t border-gray-200">
                                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Completed</h3>
                                {completedTasks.map(task => (
                                    <TaskCard 
                                        key={task.id} 
                                        task={task} 
                                        meetingTitle="" 
                                        onStatusChange={handleStatusChange}
                                        onObstacleChange={handleObstacleChange}
                                    />
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, onEmailLogin, onPasswordLogin, onSignUp, onPasswordReset }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authMethod, setAuthMethod] = useState('password'); // 'password' | 'magic'
            const [isSignUp, setIsSignUp] = useState(false); // Toggle Sign In / Sign Up
            const [isForgot, setIsForgot] = useState(false); // Toggle Forgot Password
            const [magicSent, setMagicSent] = useState(false);

            const handleMagicLink = (e) => {
                e.preventDefault();
                if(!email) return;
                onEmailLogin(email);
                setMagicSent(true);
            };

            const handlePasswordAction = (e) => {
                e.preventDefault();
                if (!email) return;
                
                if (isForgot) {
                    onPasswordReset(email);
                    setIsForgot(false); 
                    // ideally show notification
                    return;
                }

                if (isSignUp) {
                    onSignUp(email, password);
                } else {
                    onPasswordLogin(email, password);
                }
            };

            return (
                <div className="h-full flex items-center justify-center bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                        <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icon name="Calendar" className="w-8 h-8 text-indigo-600" />
                        </div>
                        <h1 className="text-2xl font-bold text-gray-900 mb-2">Welcome to MeetingMate</h1>
                        <p className="text-gray-500 mb-6">Collaborate on meeting tasks and sync with your team.</p>
                        
                        <button onClick={onLogin} className="w-full flex items-center justify-center space-x-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-lg transition-colors mb-6">
                            <Icon name="Google" className="w-5 h-5" />
                            <span>Sign in with Google</span>
                        </button>

                        <div className="relative my-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div>
                            <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">Or sign in with email</span></div>
                        </div>

                        {/* Auth Method Toggles */}
                        <div className="flex justify-center space-x-4 mb-6 text-sm">
                            <button 
                                onClick={() => setAuthMethod('password')}
                                className={`pb-1 border-b-2 transition-colors ${authMethod === 'password' ? 'border-indigo-600 text-indigo-600 font-medium' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                Password
                            </button>
                            <button 
                                onClick={() => setAuthMethod('magic')}
                                className={`pb-1 border-b-2 transition-colors ${authMethod === 'magic' ? 'border-indigo-600 text-indigo-600 font-medium' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                Magic Link
                            </button>
                        </div>

                        {authMethod === 'magic' ? (
                            !magicSent ? (
                                <form onSubmit={handleMagicLink} className="space-y-3 text-left">
                                    <div>
                                        <label className="text-xs font-medium text-gray-700">Email Address</label>
                                        <input 
                                            type="email" 
                                            placeholder="name@example.com" 
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none mt-1"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            required
                                        />
                                    </div>
                                    <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                        <Icon name="Mail" className="w-4 h-4" />
                                        <span>Send Magic Link</span>
                                    </button>
                                </form>
                            ) : (
                                <div className="mb-6 bg-green-50 text-green-700 p-3 rounded-lg text-sm">
                                    Check your email for the login link!
                                </div>
                            )
                        ) : (
                            <form onSubmit={handlePasswordAction} className="space-y-3 text-left">
                                <div>
                                    <label className="text-xs font-medium text-gray-700">Email Address</label>
                                    <input 
                                        type="email" 
                                        placeholder="name@example.com" 
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none mt-1"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                    />
                                </div>
                                
                                {!isForgot && (
                                    <div>
                                        <label className="text-xs font-medium text-gray-700">Password</label>
                                        <input 
                                            type="password" 
                                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none mt-1"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            required
                                        />
                                    </div>
                                )}

                                <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                    {isForgot ? 'Send Reset Link' : (isSignUp ? 'Create Account' : 'Sign In')}
                                </button>

                                <div className="flex justify-between text-xs mt-4">
                                    {!isForgot && (
                                        <button type="button" onClick={() => setIsSignUp(!isSignUp)} className="text-indigo-600 hover:underline">
                                            {isSignUp ? 'Already have an account? Sign In' : 'Need an account? Sign Up'}
                                        </button>
                                    )}
                                    <button type="button" onClick={() => setIsForgot(!isForgot)} className="text-gray-500 hover:text-gray-700">
                                        {isForgot ? 'Back to Login' : 'Forgot Password?'}
                                    </button>
                                </div>
                            </form>
                        )}
                        
                        <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-left">
                            <h4 className="text-xs font-bold text-yellow-800 mb-1 flex items-center">
                                <Icon name="AlertCircle" className="w-3 h-3 mr-1" />
                                Trouble Signing In?
                            </h4>
                            <p className="text-xs text-yellow-700 mb-2">
                                <strong>Google Error?</strong> Verify your Redirect URL in Google Cloud Console matches exactly:
                            </p>
                            <code className="block bg-yellow-100 p-1.5 rounded text-[10px] break-all font-mono mb-2">
                                {window.location.href}
                            </code>
                        </div>
                    </div>
                </div>
            );
        };

        const PasswordResetScreen = ({ onReset }) => {
            const [newPassword, setNewPassword] = useState('');
            const [message, setMessage] = useState('');

            const handleReset = (e) => {
                e.preventDefault();
                onReset(newPassword);
                setMessage('Password updated! Redirecting...');
            };

            return (
                <div className="h-full flex items-center justify-center bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                        <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icon name="Key" className="w-8 h-8 text-indigo-600" />
                        </div>
                        <h1 className="text-2xl font-bold text-gray-900 mb-2">Set New Password</h1>
                        <p className="text-gray-500 mb-6">Enter your new password below.</p>
                        
                        <form onSubmit={handleReset} className="space-y-4">
                            <input 
                                type="password" 
                                placeholder="New Password" 
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                value={newPassword}
                                onChange={(e) => setNewPassword(e.target.value)}
                                required
                                minLength="6"
                            />
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                Update Password
                            </button>
                        </form>
                        {message && <p className="mt-4 text-green-600 text-sm font-medium">{message}</p>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [session, setSession] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [dashboardViewMode, setDashboardViewMode] = useState('meetings'); // 'meetings' | 'tasks' | 'team' | 'reports'
            const [selectedDate, setSelectedDate] = useState(getTodayISO());
            const [selectedMeetingId, setSelectedMeetingId] = useState(null);
            const [syncRange, setSyncRange] = useState('upcoming'); 
            const [taskFilter, setTaskFilter] = useState('all'); // 'all' | 'pending' | 'completed'
            const [taskScope, setTaskScope] = useState('me'); // 'me' | 'team' - NEW SCOPE TOGGLE
            const [showQuickAdd, setShowQuickAdd] = useState(false); // Toggle for standalone task form

            // Data State
            const [meetings, setMeetings] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [teamMembers, setTeamMembers] = useState([]);
            const [colleagues, setColleagues] = useState([]);

            // Status State
            const [dbStatus, setDbStatus] = useState('connecting'); 
            const [errorMsg, setErrorMsg] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);

            // Auth Check
            useEffect(() => {
                const getSystemRole = (email) => {
                    return ADMIN_EMAILS.includes(email) ? 'admin' : 'user';
                };

                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) {
                        const role = getSystemRole(session.user.email);
                        setCurrentUser({
                            id: session.user.id,
                            name: session.user.user_metadata.full_name || session.user.email,
                            email: session.user.email,
                            system_role: role,
                            avatar: (session.user.user_metadata.full_name || 'U').substring(0, 2).toUpperCase(),
                            color: 'bg-indigo-600'
                        });
                        setLoading(false);
                        fetchData();
                    } else {
                        setLoading(false);
                    }
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    setSession(session);
                    
                    if (event === 'PASSWORD_RECOVERY') {
                        setView('reset_password');
                    }
                    
                    if (session) {
                        const role = getSystemRole(session.user.email);
                        setCurrentUser({
                            id: session.user.id,
                            name: session.user.user_metadata.full_name || session.user.email,
                            email: session.user.email,
                            system_role: role,
                            avatar: (session.user.user_metadata.full_name || 'U').substring(0, 2).toUpperCase(),
                            color: 'bg-indigo-600'
                        });
                        fetchData();
                    } else {
                        setCurrentUser(null);
                        setMeetings([]);
                        setTasks([]);
                        setTeamMembers([]);
                        setView('dashboard');
                    }
                });

                return () => subscription.unsubscribe();
            }, []);

            const handleGoogleLogin = async () => {
                const { error } = await supabase.auth.signInWithOAuth({ 
                    provider: 'google', 
                    options: { 
                        redirectTo: window.location.href, // This might need to be specific for Vercel
                        // Request Calendar Access AND Event editing (for description sync)
                        scopes: 'https://www.googleapis.com/auth/calendar.readonly' 
                    } 
                });
                if (error) alert(error.message);
            };

            const handleEmailLogin = async (email) => {
                const { error } = await supabase.auth.signInWithOtp({
                    email,
                    options: { emailRedirectTo: window.location.href }
                });
                if (error) alert(error.message);
            };
            
            const handlePasswordLogin = async (email, password) => {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) alert(error.message);
            };

            const handleSignUp = async (email, password) => {
                const { error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { full_name: email.split('@')[0] } 
                    }
                });
                if (error) {
                    alert(error.message);
                } else {
                    alert("Sign up successful! Please check your email for confirmation if required.");
                }
            };

            const handlePasswordReset = async (email) => {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.href, // Redirect back to app
                });
                if (error) alert(error.message);
                else alert("Password reset email sent!");
            };
            
            const handleUpdatePassword = async (newPassword) => {
                const { error } = await supabase.auth.updateUser({ password: newPassword });
                if (error) alert(error.message);
                else {
                    alert("Password updated successfully!");
                    setView('dashboard');
                    fetchData();
                }
            };

            const handleLogout = async () => {
                try {
                    await supabase.auth.signOut();
                } catch (error) {
                    console.error("Sign out error:", error);
                } finally {
                    setSession(null);
                    setCurrentUser(null);
                    setMeetings([]);
                    setTasks([]);
                    setTeamMembers([]);
                    setView('dashboard');
                    setSelectedMeetingId(null);
                }
            };

            const handleRemoveTeamMember = async (email) => {
                if (!confirm(`Are you sure you want to remove ${email}?`)) return;
                
                setTeamMembers(prev => prev.filter(m => m.email !== email));

                if (dbStatus === 'connected') {
                    try {
                        const { error } = await supabase.from('team_members').delete().eq('email', email);
                        if (error) throw error;
                    } catch (e) {
                        console.error(e);
                        alert("Failed to remove member");
                    }
                }
            };

            const fetchData = async () => {
                setDbStatus('connecting');
                try {
                    const { error: checkError } = await supabase.from('meetings').select('id').limit(1);
                    if (checkError && (checkError.code === 'PGRST205' || checkError.code === '42P01')) {
                        throw { code: 'TABLE_MISSING' };
                    }

                    const { data: m, error: mErr } = await supabase.from('meetings').select('*');
                    const { data: t, error: tErr } = await supabase.from('tasks').select('*');
                    const { data: tm, error: tmErr } = await supabase.from('team_members').select('*');

                    if (mErr || tErr) throw new Error("Fetch failed");

                    const parsedM = m.map(x => ({ ...x, participants: typeof x.participants === 'string' ? JSON.parse(x.participants) : x.participants || [] }));
                    const parsedT = t.map(x => ({ ...x, meetingId: x.meeting_id }));
                    const parsedTeam = tm || [];
                    
                    setTeamMembers(parsedTeam);

                    // Collate Colleagues
                    const uniqueColleaguesMap = new Map();
                    parsedTeam.forEach(member => uniqueColleaguesMap.set(member.email, member));
                    parsedM.forEach(meet => {
                        if (Array.isArray(meet.participants)) {
                            meet.participants.forEach(p => {
                                const key = p.email || p.id || p.name;
                                if (key && !uniqueColleaguesMap.has(key)) {
                                    uniqueColleaguesMap.set(key, p);
                                }
                            });
                        }
                    });
                    setColleagues(Array.from(uniqueColleaguesMap.values()));

                    setMeetings(parsedM);
                    setTasks(parsedT);
                    setDbStatus(parsedM.length ? 'connected' : 'empty');

                } catch (err) {
                    if (err.code === 'TABLE_MISSING') {
                        setDbStatus('setup_required');
                    } else {
                        console.error(err);
                        setDbStatus('error');
                        setErrorMsg(err.message);
                    }
                }
            };

            // REAL GOOGLE CALENDAR SYNC
            const handleSync = async () => {
                if (!session?.provider_token) {
                    alert("Sync Unavailable: Missing Google Access Token.\n\nExplanation: This usually happens if you refreshed the page after logging in (tokens are not persisted for security).\n\nSolution: Please 'Log Out' and 'Sign in with Google' again immediately before syncing.");
                    return;
                }

                setIsSyncing(true);
                try {
                    // Fetch range
                    let timeMin = new Date().toISOString();
                    if (syncRange === 'past_month') {
                        const d = new Date();
                        d.setDate(d.getDate() - 30);
                        timeMin = d.toISOString();
                    }

                    const resp = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?maxResults=50&orderBy=startTime&singleEvents=true&timeMin=${timeMin}`, {
                        headers: { Authorization: `Bearer ${session.provider_token}` }
                    });
                    
                    if (!resp.ok) {
                        const errData = await resp.json();
                        if (errData.error?.message?.includes("Google Calendar API has not been used")) {
                             throw new Error("API_DISABLED");
                        }
                        throw new Error(errData.error?.message || "Failed to fetch from Google");
                    }

                    const data = await resp.json();
                    
                    if (data.items.length === 0) {
                        alert("Connection successful, but 0 events found in your primary Google Calendar for this range.");
                        setIsSyncing(false);
                        return;
                    }

                    // Transform & Save
                    for (const event of data.items) {
                        const mId = event.id;
                        const docId = `doc_${event.id}`;
                        const start = new Date(event.start.dateTime || event.start.date);
                        const offset = start.getTimezoneOffset() * 60000;
                        const dateStr = new Date(start.getTime() - offset).toISOString().split('T')[0];
                        
                        // Parse description for tasks
                        const description = event.description || '';
                        const taskRegex = /(?:^|\n)(?:-? ?\[ ?\]|TODO:|Task:)\s*(.+)/gi;
                        let match;
                        while ((match = taskRegex.exec(description)) !== null) {
                            const taskText = match[1].trim();
                            if (taskText) {
                                const taskId = `t_${event.id}_${taskText.substring(0, 5).replace(/\s/g, '')}`;
                                await supabase.from('tasks').upsert({
                                    id: taskId,
                                    meeting_id: mId,
                                    text: taskText,
                                    assignee: currentUser.id, // Assign to self initially
                                    status: 'pending' // Default status
                                }, { ignoreDuplicates: true });
                            }
                        }

                        // Extract Attendees
                        const attendees = event.attendees ? event.attendees.map(a => ({
                            id: a.email,
                            email: a.email,
                            name: a.displayName || a.email.split('@')[0],
                            avatar: (a.displayName || a.email).substring(0,2).toUpperCase()
                        })) : [];
                        
                        // Force include current user (the owner of the calendar) in participants
                        const userInAttendees = attendees.find(a => a.email && a.email.toLowerCase() === currentUser.email.toLowerCase());
                        if (!userInAttendees) {
                            attendees.push({
                                id: currentUser.id, // Use Supabase ID for me
                                email: currentUser.email,
                                name: currentUser.name,
                                avatar: currentUser.avatar
                            });
                        }

                        // Check for Google Doc Attachment
                        let gDocLink = null;
                        if (event.attachments) {
                            const gDoc = event.attachments.find(a => a.mimeType === 'application/vnd.google-apps.document');
                            if (gDoc) gDocLink = gDoc.fileUrl;
                        }

                        // Upsert Meeting (This ensures new participants merge in a real DB, but here we replace to keep sync simple)
                        // In a real production app we would read existing participants and merge. Here we overwrite with GCal source of truth.
                        await supabase.from('meetings').upsert({
                            id: mId,
                            title: event.summary || '(No Title)',
                            date: dateStr,
                            time: start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            duration: '1h',
                            participants: attendees, // Store full object array
                            doc_id: docId,
                            google_calendar_id: event.id,
                            synced: true,
                            platform: 'Google Calendar',
                            google_doc_link: gDocLink
                        });
                        
                        // Note: Notes syncing removed as requested
                    }
                    
                    await fetchData();
                    alert(`Successfully synced ${data.items.length} events from Google Calendar!`);

                } catch (e) {
                    console.error(e);
                    if (e.message === "API_DISABLED") {
                        alert("Action Required: Google Calendar API is not enabled.\n\n1. Go to Google Cloud Console (console.cloud.google.com)\n2. Select your project\n3. Go to 'APIs & Services' > 'Library'\n4. Search for 'Google Calendar API' and click ENABLE.\n5. Wait 2 minutes and try again.");
                    } else {
                        alert("Sync Error: " + e.message);
                    }
                } finally {
                    setIsSyncing(false);
                }
            };

            const handleAddTeamMember = async (email, name, team, role, systemRole) => {
                if (!email.endsWith('@tempo.fit')) {
                    alert('Invalid email domain. Must be @tempo.fit');
                    return;
                }
                
                try {
                    const { error } = await supabase.from('team_members').insert({
                        email, 
                        name,
                        team,
                        role,
                        system_role: systemRole
                    });
                    
                    if (error) throw error;
                    
                    await fetchData(); // Refresh list
                    alert(`Added ${name} to team.`);
                } catch(e) {
                    alert("Error adding member: " + e.message);
                }
            };
            
            const handleUpdateTeamMember = async (email, updates) => {
                // 1. Update Colleagues State (Immediate UI)
                setColleagues(prev => prev.map(c => 
                    (c.email === email || c.id === email) ? { ...c, ...updates } : c
                ));
                setTeamMembers(prev => prev.map(m => m.email === email ? { ...m, ...updates } : m));

                // 2. Prepare data for DB
                const user = colleagues.find(c => c.email === email || c.id === email);
                const name = user ? (user.name || user.email) : email;

                if (dbStatus === 'connected') {
                    try {
                        const { error } = await supabase.from('team_members').upsert({
                            email,
                            name,
                            ...updates
                        });
                        if (error) throw error;
                    } catch (e) {
                        console.error("Error updating team member:", e);
                        alert("Failed to update team member.");
                    }
                }
            };

            // Generic Task Update Handler
            const handleUpdateTask = async (taskId, updates) => {
                // Optimistic UI Update
                setTasks(prev => prev.map(t => t.id === taskId ? { ...t, ...updates } : t));
                
                if (dbStatus === 'connected') {
                    // Debounce obstacle updates if needed, but simple update for now
                    await supabase.from('tasks').update(updates).eq('id', taskId);
                }
            };

            // --- STANDALONE TASK ADDITION ---
            const handleAddStandaloneTask = (text, assigneeId) => {
                if (!text.trim()) return;
                const newId = `t_${Date.now()}`;
                const newTask = {
                    id: newId,
                    meeting_id: 'standalone',
                    text: text,
                    assignee: assigneeId || currentUser.id, // Assign to selected or self
                    status: 'pending',
                    start_date: getTodayISO(),
                    end_date: getTodayISO()
                };

                // Optimistic
                setTasks(prev => [newTask, ...prev]);
                
                if (dbStatus === 'connected') {
                    supabase.from('tasks').insert(newTask).then(({error}) => {
                        if(error) console.error("Error saving standalone task", error);
                    });
                }
                setShowQuickAdd(false);
            };

            // Check if current user is a manager or admin
            const isManager = useMemo(() => {
                if (!currentUser) return false;
                if (currentUser.system_role === 'admin') return true;
                
                // Check team_members table for role 'Owner' or managed_teams
                const memberRecord = teamMembers.find(m => 
                    m.email && m.email.toLowerCase() === (currentUser.email || '').toLowerCase()
                );
                
                if (memberRecord) {
                    if (memberRecord.role === 'Owner') return true;
                    if (memberRecord.managed_teams && memberRecord.managed_teams.length > 0) return true;
                }
                
                return false;
            }, [currentUser, teamMembers]);

            // --- MEETING LIST LOGIC (All meetings, sorted by date) ---
            const sortedMeetings = useMemo(() => {
                if (!currentUser) return [];
                
                const userEmail = (currentUser.email || '').toLowerCase().trim();
                const userId = currentUser.id;

                // Filter by participant (strict check on email or ID)
                const userMeetings = meetings.filter(m => {
                    const parts = m.participants || [];
                    return parts.some(p => {
                        // Handle legacy string array or object array
                        if (typeof p === 'string') {
                             const pLower = p.toLowerCase().trim();
                             return p === userId || pLower === userEmail;
                        }
                        
                        // Object case
                        const pId = p.id; 
                        const pEmail = p.email ? p.email.toLowerCase().trim() : '';
                        
                        // Match ID (Supabase UUID)
                        if (pId === userId) return true;
                        // Match Email
                        if (pEmail === userEmail) return true;
                        // Match ID acting as Email
                        if (typeof pId === 'string' && pId.toLowerCase().trim() === userEmail) return true;
                        
                        return false;
                    });
                });

                // Filter by Selected Date IF selected (and if it's not empty)
                const dateFiltered = selectedDate 
                    ? userMeetings.filter(m => m.date === selectedDate)
                    : userMeetings;
                
                // Sort Descending (Newest first)
                return dateFiltered.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateB - dateA;
                });
            }, [meetings, currentUser, selectedDate]);

            // --- FILTER TASKS LOGIC ---
            const filteredTasks = useMemo(() => {
                // First filter by SCOPE (Me vs My Team)
                let scopeFiltered = [];
                
                // If not manager, force 'me' scope. If manager, respect taskScope.
                // Note: isManager is calculated above.
                const effectiveScope = isManager ? taskScope : 'me';

                if (effectiveScope === 'me') {
                    const myEmail = (currentUser?.email || '').toLowerCase().trim();
                    const myId = currentUser?.id;

                    scopeFiltered = tasks.filter(t => {
                        const assignee = (t.assignee || '').toLowerCase().trim();
                        return assignee === myId || assignee === myEmail;
                    }); 
                } else if (effectiveScope === 'team') {
                    // Find teams user manages
                    const myManagedTeams = [];
                    const userEmail = (currentUser?.email || '').toLowerCase();
                    
                    const meInTeam = teamMembers.find(tm => tm.email && tm.email.toLowerCase() === userEmail);
                    
                    if (meInTeam) {
                        // Direct ownership of a team
                        // Note: If role is Owner, they manage their own team (meInTeam.team)
                        if (meInTeam.role === 'Owner' && meInTeam.team) {
                            myManagedTeams.push(meInTeam.team);
                        }
                        
                        // Delegated management
                        if (meInTeam.managed_teams && Array.isArray(meInTeam.managed_teams)) {
                            myManagedTeams.push(...meInTeam.managed_teams);
                        }
                    }
                    
                    // If admin, maybe show all teams? Or just let them see based on above?
                    // Let's refine `myManagedTeams` for Admin.
                    if (currentUser?.system_role === 'admin') {
                         myManagedTeams.push(...DEPARTMENTS);
                    }

                    // Get all members of these teams
                    const teamMemberEmails = teamMembers
                        .filter(tm => myManagedTeams.includes(tm.team))
                        .map(tm => tm.email);
                        
                    // Include tasks assigned to these emails
                    scopeFiltered = tasks.filter(t => teamMemberEmails.includes(t.assignee));
                }

                // Second filter by STATUS (All / Pending / Completed)
                if (taskFilter === 'all') return scopeFiltered;
                if (taskFilter === 'completed') return scopeFiltered.filter(t => (t.status === 'completed' || t.done));
                if (taskFilter === 'pending') return scopeFiltered.filter(t => (t.status !== 'completed' && !t.done));
                return scopeFiltered;
            }, [tasks, taskFilter, taskScope, currentUser, teamMembers, session, isManager]);

            // Combine participants for robust assignment
            const allPossibleAssignees = useMemo(() => {
                const combined = [...teamMembers, ...colleagues];
                const unique = new Map();
                
                if (currentUser) unique.set(currentUser.id, currentUser);

                combined.forEach(u => {
                    const key = u.email || u.id;
                    if (key && !unique.has(key)) unique.set(key, u);
                });
                
                return Array.from(unique.values());
            }, [teamMembers, colleagues, currentUser]);

            if (loading) return null;

            if (!session) {
                if (view === 'reset_password') {
                     return <PasswordResetScreen onReset={handleUpdatePassword} />;
                }
                return <LoginScreen onLogin={handleGoogleLogin} onEmailLogin={handleEmailLogin} onPasswordLogin={handlePasswordLogin} onSignUp={handleSignUp} onPasswordReset={handlePasswordReset} />;
            }
            // Edge case: if session exists but we want to show reset screen (e.g. clicked link while logged in? Unlikely, supabase clears session usually)
            // But if onAuthStateChange triggered PASSWORD_RECOVERY, view is set to reset_password
             if (view === 'reset_password') {
                 return <PasswordResetScreen onReset={handleUpdatePassword} />;
            }

            // --- Dashboard View ---
            if (view === 'dashboard') {
                return (
                    <div className="flex flex-col h-screen bg-gray-50">
                        <AppHeader 
                            currentUser={currentUser} 
                            onLogout={handleLogout} 
                            onSync={handleSync}
                            dbStatus={dbStatus}
                            isSyncing={isSyncing}
                            syncRange={syncRange}
                            setSyncRange={setSyncRange}
                        />

                        <main className="flex-1 overflow-y-auto p-6">
                            <div className="max-w-5xl mx-auto">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900">
                                            {dashboardViewMode === 'meetings' ? 'My Meetings' : (dashboardViewMode === 'tasks' ? 'My Tasks' : (dashboardViewMode === 'team' ? 'Team' : 'Reports'))}
                                        </h2>
                                        <p className="text-gray-500 text-sm mt-1">
                                            {currentUser.name}
                                        </p>
                                    </div>
                                    <div className="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                                        <div className="flex items-center space-x-1 bg-white p-1 rounded-lg border border-gray-200 shadow-sm w-full sm:w-auto">
                                             <button onClick={() => setDashboardViewMode('meetings')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'meetings' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}`}>Meetings</button>
                                             <button onClick={() => setDashboardViewMode('tasks')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'tasks' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}`}>Tasks</button>
                                             
                                                
                                                    <button onClick={() => setDashboardViewMode('team')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'team' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}`}>Team</button>
                                                    <button onClick={() => setDashboardViewMode('reports')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'reports' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}`}>Reports</button>
                                                
                                            
                                        </div>
                                        
                                        {/* Date Picker - With Show All Toggle */}
                                        {dashboardViewMode === 'meetings' && (
                                            <div className="flex items-center gap-2">
                                                <div className="relative w-full sm:w-auto">
                                                    <input
                                                        type="date"
                                                        value={selectedDate}
                                                        onChange={(e) => setSelectedDate(e.target.value)}
                                                        className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                                    />
                                                    <Icon name="Calendar" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none" />
                                                </div>
                                                {selectedDate && (
                                                    <button 
                                                        onClick={() => setSelectedDate('')}
                                                        className="text-xs text-indigo-600 hover:text-indigo-800 underline whitespace-nowrap"
                                                    >
                                                        Show All
                                                    </button>
                                                )}
                                            </div>
                                        )}

                                        {dashboardViewMode === 'tasks' && (
                                            <div className="flex gap-2 w-full sm:w-auto items-center">
                                                {/* Only show scope toggle if manager */}
                                                {isManager && (
                                                    <div className="flex items-center bg-white border border-gray-200 rounded-lg p-0.5">
                                                        <button onClick={() => setTaskScope('me')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${taskScope === 'me' ? 'bg-gray-100 text-gray-900' : 'text-gray-500'}`}>Me</button>
                                                        <button onClick={() => setTaskScope('team')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${taskScope === 'team' ? 'bg-gray-100 text-gray-900' : 'text-gray-500'}`}>My Team</button>
                                                    </div>
                                                )}
                                                <select
                                                    value={taskFilter}
                                                    onChange={(e) => setTaskFilter(e.target.value)}
                                                    className="w-full pl-3 pr-8 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                                >
                                                    <option value="all">All Status</option>
                                                    <option value="pending">Pending</option>
                                                    <option value="completed">Completed</option>
                                                </select>
                                                <button 
                                                    onClick={() => setShowQuickAdd(!showQuickAdd)} 
                                                    className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700"
                                                    title="Add Personal Task"
                                                >
                                                    <Icon name="Plus" className="w-4 h-4" />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {dbStatus === 'setup_required' && (
                                    <div className="bg-red-50 border border-red-200 p-6 rounded-lg mb-6">
                                        <h3 className="font-bold text-red-900 mb-2">Database Missing Tables</h3>
                                        <p className="text-sm text-red-700 mb-4">Run this SQL in your Supabase Dashboard:</p>
                                        <div className="bg-gray-900 text-gray-100 p-3 rounded text-xs overflow-auto max-h-32 mb-4"><pre>{SQL_SETUP_INSTRUCTIONS}</pre></div>
                                        <button onClick={fetchData} className="bg-red-600 text-white px-4 py-2 rounded text-sm">Retry Connection</button>
                                    </div>
                                )}

                                {dashboardViewMode === 'meetings' ? (
                                    <>
                                        {sortedMeetings.length > 0 ? (
                                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                {/* Group or just list. Simple list for now */}
                                                {sortedMeetings.map(m => <MeetingCard key={m.id} meeting={m} onClick={() => { setSelectedMeetingId(m.id); setView('meeting'); }} />)}
                                            </div>
                                        ) : (
                                            <div className="text-center py-20 bg-white rounded-xl border border-dashed">
                                                <p className="text-gray-500">No meetings found {selectedDate ? `for ${selectedDate}` : ''}.</p>
                                                {dbStatus === 'empty' && <p className="text-sm text-indigo-500 mt-2">Click "Sync" to load from Google.</p>}
                                            </div>
                                        )}
                                    </>
                                ) : dashboardViewMode === 'tasks' ? (
                                    <div className="space-y-4">
                                        {/* QUICK ADD TASK FORM */}
                                        {showQuickAdd && (
                                            <div className="bg-white border border-indigo-100 p-4 rounded-lg shadow-sm mb-4 animate-in fade-in slide-in-from-top-2">
                                                <form onSubmit={(e) => { 
                                                    e.preventDefault(); 
                                                    handleAddStandaloneTask(e.target.elements.taskText.value, e.target.elements.taskAssignee.value); 
                                                    e.target.reset(); 
                                                }} className="flex flex-col sm:flex-row gap-2">
                                                    <input name="taskText" type="text" placeholder="What do you need to do?" className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" autoFocus />
                                                    <select name="taskAssignee" className="border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white" defaultValue={currentUser?.id}>
                                                        <option value={currentUser?.id}>Me</option>
                                                        {allPossibleAssignees.filter(u => (u.id || u.email) !== currentUser?.id).map(u => (
                                                            <option key={u.id || u.email} value={u.id || u.email}>{u.name || u.email}</option>
                                                        ))}
                                                    </select>
                                                    <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-medium whitespace-nowrap">Add Task</button>
                                                </form>
                                            </div>
                                        )}

                                        {filteredTasks.length > 0 ? (
                                            filteredTasks.map(t => {
                                                const mtg = meetings.find(m => m.id === t.meetingId);
                                                // Resolve user from all colleagues
                                                const user = allPossibleAssignees.find(c => c.email === t.assignee || c.id === t.assignee) || { name: 'Unknown' };
                                                t.assigneeName = user.name || user.email;

                                                return (
                                                    <TaskCard 
                                                        key={t.id} 
                                                        task={t} 
                                                        meetingTitle={mtg ? mtg.title : (t.meeting_id === 'standalone' ? 'Personal Task' : 'Unknown Meeting')} 
                                                        // Pass correct handler signature: (id, value) -> update function
                                                        onStatusChange={(id, val) => handleUpdateTask(id, { status: val, done: val === 'completed' })}
                                                        onObstacleChange={(id, val) => handleUpdateTask(id, { obstacles: val })}
                                                    />
                                                );
                                            })
                                        ) : (
                                            <div className="text-center py-12 bg-white rounded-xl border border-dashed text-gray-500">
                                                No tasks found matching filter.
                                            </div>
                                        )}
                                    </div>
                                ) : dashboardViewMode === 'team' ? (
                                    <TeamList 
                                        teamMembers={teamMembers} 
                                        colleagues={colleagues}
                                        onAddMember={handleAddTeamMember} 
                                        onUpdateMember={handleUpdateTeamMember}
                                        onRemoveMember={handleRemoveTeamMember}
                                    />
                                ) : (
                                    /* Reports View */
                                    <ReportsView meetings={meetings} tasks={tasks} attendees={allPossibleAssignees} />
                                )}
                            </div>
                        </main>
                    </div>
                );
            }

            const m = meetings.find(x => x.id === selectedMeetingId);
            if (!m) return null;

            return (
                <div className="flex flex-col h-screen bg-white">
                    <AppHeader 
                        currentUser={currentUser} 
                        onLogout={handleLogout} 
                        dbStatus={dbStatus} 
                        onBack={() => setView('dashboard')}
                        title={m.title}
                    />
                    <div className="flex-1 overflow-hidden flex flex-col">
                        {/* Task Manager now takes full width since Notes are removed */}
                        <TaskManager 
                            tasks={tasks.filter(t => t.meetingId === m.id)}
                            attendees={allPossibleAssignees}
                            currentUserId={currentUser ? currentUser.id : null}
                            onUpdateTask={handleUpdateTask}
                            onAdd={(mId, text, assignee, start, end) => { // Added start, end
                                const newId = `t_${Date.now()}`;
                                setTasks(prev => [...prev, { id: newId, meetingId: mId, text, assignee, status: 'pending', start_date: start, end_date: end }]);
                                if (dbStatus === 'connected') {
                                    supabase.from('tasks').insert({ 
                                        id: newId, 
                                        meeting_id: mId, 
                                        text, 
                                        assignee, 
                                        status: 'pending',
                                        start_date: start,
                                        end_date: end 
                                    }).then();
                                }
                            }}
                            meetingId={m.id}
                            teamMembers={teamMembers} // Pass teamMembers for proper role resolution inside TaskManager
                        />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
