<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetingMate - Collaborative Meeting Tool</title>
    
    <!-- Robust Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="background-color: #FEF2F2; color: #991B1B; padding: 2rem; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Startup Error</h2>
                        <div style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #FCA5A5; text-align: left; max-width: 600px; overflow-x: auto;">
                            <code style="font-family: monospace;">${msg}</code>
                        </div>
                    </div>
                `;
            }
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .prose h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #111827; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; color: #374151; }
        .prose:focus { outline: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden">
    <!-- Initial Loading State -->
    <div id="root" class="h-full flex items-center justify-center">
        <div class="text-center text-gray-500 animate-pulse">
            <p>Loading MeetingMate...</p>
        </div>
    </div>

    <script type="text/babel">
        // Dependency Check
        if (!window.React || !window.ReactDOM || !window.supabase) {
            throw new Error("Missing dependencies. Check internet connection.");
        }

        const { useState, useEffect, useRef } = React;

        // --- Configuration ---
        const SUPABASE_URL = 'https://yasoowbpyknuikdvlahz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_7upkUKZm8t5fQh9EwLVFbQ_DmnLAObn';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error("Supabase Init Error:", e);
            throw new Error("Failed to initialize Supabase client.");
        }

        // --- Utils ---
        const getTodayISO = () => {
            const d = new Date();
            // Handle timezone offset to ensure "today" is accurate to user's local time
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };

        // --- Icons ---
        const Icon = ({ name, className, ...props }) => {
            const icons = {
                Calendar: <path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm-13 0V2m12 2V2M3 10h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Clock: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm0-14v6l4 2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Video: <path d="m22 8-6 4 6 4V8Z M16 19h-4m-4 0H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Search: <path d="m21 21-4.3-4.3 M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Plus: <path d="M12 5v14M5 12h14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                ChevronLeft: <path d="m15 18-6-6 6-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8 M21 3v5h-5 M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16 M3 21v-5h5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Database: <path d="M3 5V19A9 3 0 0 0 21 19V5 M3 5A9 3 0 0 1 21 5 M3 5A9 3 0 0 0 21 5 M3 12A9 3 0 0 0 21 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                UploadCloud: <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242 M12 12v9 M16 16l-4-4-4 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Trash2: <path d="M3 6h18 M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6 M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2 M10 11v6 M14 11v6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                AlertCircle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9h2m-2 4h2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                CheckSquare: <path d="m9 11 3 3L22 4 M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                FileText: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M14 2v6h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Bold: <path d="M14 12a4 4 0 0 0 0-8H6v8 M15 20a4 4 0 0 0 0-8H6v8Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Italic: <path d="M19 4h-9M14 20H5M15 4L9 20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Underline: <path d="M6 4v6a6 6 0 0 0 12 0V4 M4 20h16" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Share2: <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Circle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                CheckCircle2: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9 2 2 4-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                X: <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Google: <React.Fragment><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M24 12c0-.82-.07-1.63-.2-2.43H12v4.6h6.77c-.29 1.55-1.16 2.87-2.48 3.75l.02-.02 3.55 2.75c2.08-1.91 3.28-4.73 3.28-8.22z" fill="#4285F4"/></React.Fragment>,
                Mail: <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6l-10 7L2 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="24" height="24" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    className={className}
                    {...props}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/>}
                </svg>
            );
        };

        const SQL_SETUP_INSTRUCTIONS = `
        -- Run these commands in your Supabase SQL Editor to enable full persistence:
        
        create table meetings (
            id text primary key,
            title text,
            date text,
            time text,
            duration text,
            participants jsonb, 
            doc_id text,
            google_calendar_id text,
            synced boolean,
            platform text
        );

        create table tasks (
            id text primary key,
            meeting_id text,
            text text,
            assignee text,
            done boolean
        );

        create table docs (
            id text primary key,
            content text
        );
        `;

        // --- Mock Users for UI (Avatars only) ---
        const MOCK_DB_USERS = [
            { id: 'u1', name: 'Alice Chen', role: 'Product Manager', avatar: 'AC', color: 'bg-blue-500' },
            { id: 'u2', name: 'Bob Smith', role: 'Developer', avatar: 'BS', color: 'bg-green-500' },
            { id: 'u3', name: 'Charlie Kim', role: 'Designer', avatar: 'CK', color: 'bg-purple-500' },
            { id: 'u4', name: 'Dana Lee', role: 'VP Engineering', avatar: 'DL', color: 'bg-orange-500' },
        ];

        // --- Components ---

        const UserAvatar = ({ user, size = 'md' }) => {
            const sizeClasses = { sm: 'w-6 h-6 text-xs', md: 'w-8 h-8 text-sm', lg: 'w-10 h-10 text-base' };
            if (!user) return null;
            return (
                <div className={`${sizeClasses[size]} ${user.color || 'bg-indigo-600'} rounded-full flex items-center justify-center text-white font-medium ring-2 ring-white select-none uppercase`} title={user.name}>
                    {user.avatar || user.name.substring(0,2)}
                </div>
            );
        };

        // SHARED HEADER COMPONENT
        const AppHeader = ({ currentUser, onLogout, onClear, onSync, dbStatus, onBack, title, isSyncing, syncRange, setSyncRange }) => (
            <header className="bg-white border-b h-16 flex items-center justify-between px-4 sm:px-6 shrink-0 sticky top-0 z-20">
                <div className="flex items-center space-x-3">
                    {onBack && (
                        <button onClick={onBack} className="p-1.5 hover:bg-gray-100 rounded-full text-gray-500 mr-1 transition-colors">
                            <Icon name="ChevronLeft" className="w-5 h-5" />
                        </button>
                    )}
                    {!onBack && <div className="bg-indigo-600 p-1.5 rounded-lg"><Icon name="Calendar" className="text-white w-5 h-5" /></div>}
                    
                    <div>
                        <h1 className="font-bold text-gray-800 text-lg leading-tight truncate max-w-[150px] sm:max-w-none">{title || 'SyncMeet'}</h1>
                    </div>

                    {dbStatus === 'connected' && <span className="bg-green-100 text-green-700 text-[10px] uppercase font-bold tracking-wide px-2 py-0.5 rounded-full">Live</span>}
                    {dbStatus === 'setup_required' && <span className="bg-red-100 text-red-700 text-[10px] uppercase font-bold tracking-wide px-2 py-0.5 rounded-full">DB Setup</span>}
                </div>
                <div className="flex items-center space-x-3 sm:space-x-4">
                    {onSync && (dbStatus === 'empty' || dbStatus === 'connected') && 
                        <div className="flex items-center space-x-2">
                            <select 
                                value={syncRange}
                                onChange={(e) => setSyncRange(e.target.value)}
                                className="text-xs border-gray-300 rounded border p-1 text-gray-600 focus:outline-none focus:ring-1 focus:ring-indigo-500 hidden sm:block"
                            >
                                <option value="upcoming">Upcoming</option>
                                <option value="past_month">Past 30 Days</option>
                            </select>
                            <button onClick={onSync} disabled={isSyncing} className="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center disabled:opacity-50">
                                <Icon name="RefreshCw" className={`w-4 h-4 mr-1 ${isSyncing ? 'animate-spin' : ''}`}/> 
                                <span className="hidden sm:inline">{isSyncing ? 'Syncing...' : 'Sync'}</span>
                            </button>
                        </div>
                    }
                    {onClear && (dbStatus === 'empty' || dbStatus === 'connected') && 
                        <button onClick={onClear} className="text-sm font-medium text-red-500 hover:text-red-700 flex items-center" title="Delete All Data">
                            <Icon name="Trash2" className="w-4 h-4 mr-1"/> 
                            <span className="hidden sm:inline">Clear DB</span>
                        </button>
                    }
                    <div className="h-6 w-px bg-gray-200 mx-1 hidden sm:block"></div>
                    <div className="flex items-center space-x-2">
                        <UserAvatar user={currentUser} size="sm" />
                        <span className="text-sm font-medium text-gray-700 hidden md:inline truncate max-w-[100px]">{currentUser.name}</span>
                        <button onClick={onLogout} className="bg-white border border-gray-200 text-gray-600 hover:text-red-600 hover:bg-red-50 px-3 py-1.5 rounded-md text-sm font-medium transition-colors shadow-sm ml-2" title="Log Out">
                            Log Out
                        </button>
                    </div>
                </div>
            </header>
        );

        const MeetingCard = ({ meeting, users, onClick }) => {
            const participantIds = Array.isArray(meeting.participants) ? meeting.participants : [];
            const attendees = participantIds.map(id => users.find(u => u.id === id) || {id, name: 'Guest', avatar: 'G', color: 'bg-gray-400'}).slice(0, 4);
            
            return (
                <div onClick={onClick} className="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-lg hover:border-indigo-200 transition-all cursor-pointer group">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <h3 className="font-semibold text-gray-900 group-hover:text-indigo-600 transition-colors">{meeting.title}</h3>
                            <div className="flex items-center text-gray-500 text-sm mt-1 space-x-3">
                                {meeting.date && <span className="flex items-center"><Icon name="Calendar" className="w-3 h-3 mr-1" /> {meeting.date}</span>}
                                {meeting.time && <span className="flex items-center"><Icon name="Clock" className="w-3 h-3 mr-1" /> {meeting.time}</span>}
                            </div>
                        </div>
                        {meeting.synced && <div className="bg-blue-50 text-blue-600 p-1.5 rounded-full"><Icon name="Calendar" className="w-4 h-4" /></div>}
                    </div>
                    <div className="flex justify-between items-center mt-4">
                        <div className="flex -space-x-2">
                            {attendees.map((user, i) => <UserAvatar key={i} user={user} size="sm" />)}
                        </div>
                        <div className="flex items-center text-gray-400 text-sm space-x-1 group-hover:text-indigo-500 transition-colors">
                            <span>Open Notes</span>
                            <Icon name="ChevronLeft" className="w-4 h-4 rotate-180" />
                        </div>
                    </div>
                </div>
            );
        };

        const TaskCard = ({ task, meetingTitle, onToggle }) => (
            <div className="bg-white border border-gray-200 rounded-lg p-4 flex items-start space-x-3 hover:shadow-sm transition-shadow">
                <button onClick={() => onToggle(task.id, !task.done)} className={`mt-0.5 ${task.done ? 'text-green-600' : 'text-gray-400 hover:text-green-600'}`}>
                    <Icon name={task.done ? "CheckCircle2" : "Circle"} className="w-5 h-5" />
                </button>
                <div className="flex-1">
                    <p className={`text-sm font-medium ${task.done ? 'text-gray-500 line-through' : 'text-gray-900'}`}>{task.text}</p>
                    <p className="text-xs text-gray-500 mt-1 flex items-center">
                        <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[200px]">From: {meetingTitle}</span>
                    </p>
                </div>
            </div>
        );

        const GoogleDocEditor = ({ docContent, title, onSave }) => {
            const [localContent, setLocalContent] = useState(docContent);
            const timeoutRef = useRef(null);
            useEffect(() => { setLocalContent(docContent || '<p class="text-gray-400 italic">Start typing...</p>'); }, [docContent]);
            const handleChange = (e) => {
                const newContent = e.currentTarget.innerHTML;
                if (timeoutRef.current) clearTimeout(timeoutRef.current);
                timeoutRef.current = setTimeout(() => { onSave(newContent); }, 1000);
            };
            return (
                <div className="flex flex-col h-full bg-gray-100 rounded-lg overflow-hidden border border-gray-300">
                    <div className="bg-white border-b border-gray-200 p-2 flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                            <div className="bg-blue-600 p-1.5 rounded text-white"><Icon name="FileText" className="w-5 h-5" /></div>
                            <h3 className="text-sm font-medium text-gray-800 leading-tight truncate max-w-[200px]">{title}</h3>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-8 flex justify-center">
                        <div className="bg-white w-full max-w-3xl shadow-sm min-h-full p-12 outline-none">
                            <div className="prose max-w-none focus:outline-none" contentEditable suppressContentEditableWarning dangerouslySetInnerHTML={{ __html: localContent }} onInput={handleChange} />
                        </div>
                    </div>
                </div>
            );
        };

        const TaskManager = ({ tasks, users, onToggle, onAdd, meetingId, currentUserId }) => {
            const [newTaskText, setNewTaskText] = useState('');
            const [assignee, setAssignee] = useState(currentUserId || users[0].id);

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newTaskText.trim()) return;
                onAdd(meetingId, newTaskText, assignee);
                setNewTaskText('');
            };

            const activeTasks = tasks.filter(t => !t.done);
            const completedTasks = tasks.filter(t => t.done);

            return (
                <div className="h-full flex flex-col bg-white border-l border-gray-200 w-80 shrink-0">
                    <div className="p-4 border-b border-gray-200 bg-gray-50">
                        <h2 className="font-semibold text-gray-800 flex items-center">
                            <Icon name="CheckSquare" className="w-4 h-4 mr-2 text-indigo-600" />
                            Action Items
                        </h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        <div className="space-y-3">
                            <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider">To Do</h3>
                            {activeTasks.length === 0 && <p className="text-sm text-gray-400 italic">No open tasks.</p>}
                            {activeTasks.map(task => {
                                const assignedUser = users.find(u => u.id === task.assignee);
                                return (
                                    <div key={task.id} className="group bg-white border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-all">
                                        <div className="flex items-start space-x-3">
                                            <button onClick={() => onToggle(task.id, !task.done)} className="mt-0.5 text-gray-400 hover:text-green-600 transition-colors">
                                                <Icon name="Circle" className="w-5 h-5" />
                                            </button>
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-800">{task.text}</p>
                                                <div className="mt-2 flex items-center justify-between">
                                                    <div className="flex items-center space-x-1.5 bg-gray-100 px-2 py-0.5 rounded-full">
                                                        <UserAvatar user={assignedUser} size="xs" />
                                                        <span className="text-xs text-gray-600">{assignedUser ? assignedUser.name.split(' ')[0] : 'Unassigned'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        {completedTasks.length > 0 && (
                            <div className="space-y-3 pt-4 border-t border-gray-100">
                                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Completed</h3>
                                {completedTasks.map(task => (
                                    <div key={task.id} className="flex items-center space-x-3 p-2 opacity-60">
                                        <button onClick={() => onToggle(task.id, !task.done)} className="text-green-600">
                                            <Icon name="CheckCircle2" className="w-5 h-5" />
                                        </button>
                                        <span className="text-sm text-gray-500 line-through">{task.text}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="p-4 border-t border-gray-200 bg-gray-50">
                        <form onSubmit={handleAdd}>
                            <input type="text" placeholder="New task..." className="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 mb-2 p-2 border" value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} />
                            <div className="flex items-center space-x-2">
                                <select className="flex-1 text-sm border-gray-300 rounded-md shadow-sm border p-1.5" value={assignee} onChange={(e) => setAssignee(e.target.value)}>
                                    <option value={currentUserId}>Me</option>
                                    {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                </select>
                                <button type="submit" disabled={!newTaskText.trim()} className="bg-indigo-600 text-white p-1.5 rounded-md hover:bg-indigo-700 disabled:opacity-50">
                                    <Icon name="Plus" className="w-5 h-5" />
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, onEmailLogin }) => {
            const [email, setEmail] = useState('');
            const [sent, setSent] = useState(false);

            const handleMagicLink = (e) => {
                e.preventDefault();
                if(!email) return;
                onEmailLogin(email);
                setSent(true);
            };

            return (
                <div className="h-full flex items-center justify-center bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                        <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icon name="Calendar" className="w-8 h-8 text-indigo-600" />
                        </div>
                        <h1 className="text-2xl font-bold text-gray-900 mb-2">Welcome to MeetingMate</h1>
                        <p className="text-gray-500 mb-8">Collaborate on meeting notes, track tasks, and sync with your team.</p>
                        
                        <button onClick={onLogin} className="w-full flex items-center justify-center space-x-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-lg transition-colors mb-6">
                            <Icon name="Google" className="w-5 h-5" />
                            <span>Sign in with Google</span>
                        </button>

                        <div className="relative my-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div>
                            <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">Or sign in with email</span></div>
                        </div>

                        {!sent ? (
                            <form onSubmit={handleMagicLink} className="mb-6 space-y-3">
                                <input 
                                    type="email" 
                                    placeholder="name@example.com" 
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                                <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                    <Icon name="Mail" className="w-4 h-4" />
                                    <span>Send Magic Link</span>
                                </button>
                            </form>
                        ) : (
                            <div className="mb-6 bg-green-50 text-green-700 p-3 rounded-lg text-sm">
                                Check your email for the login link!
                            </div>
                        )}
                        
                        <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-left">
                            <h4 className="text-xs font-bold text-yellow-800 mb-1 flex items-center">
                                <Icon name="AlertCircle" className="w-3 h-3 mr-1" />
                                Trouble Signing In?
                            </h4>
                            <p className="text-xs text-yellow-700 mb-2">
                                <strong>Google Error?</strong> Verify your Redirect URL in Google Cloud Console matches exactly:
                            </p>
                            <code className="block bg-yellow-100 p-1.5 rounded text-[10px] break-all font-mono mb-2">
                                {window.location.href}
                            </code>
                            <p className="text-xs text-yellow-700">
                                Magic Link (Email) works, but <strong>Calendar Sync requires Google Login</strong>.
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [session, setSession] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [dashboardViewMode, setDashboardViewMode] = useState('meetings'); // 'meetings' | 'tasks'
            const [selectedDate, setSelectedDate] = useState(getTodayISO());
            const [selectedMeetingId, setSelectedMeetingId] = useState(null);
            const [syncRange, setSyncRange] = useState('upcoming'); // 'upcoming' | 'past_month'
            
            // Data State
            const [meetings, setMeetings] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [docs, setDocs] = useState({});
            
            // Status State
            const [dbStatus, setDbStatus] = useState('connecting'); 
            const [errorMsg, setErrorMsg] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);

            // Auth Check
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) {
                        setCurrentUser({
                            id: session.user.id,
                            name: session.user.user_metadata.full_name || session.user.email,
                            role: 'Owner',
                            avatar: (session.user.user_metadata.full_name || 'U').substring(0, 2).toUpperCase(),
                            color: 'bg-indigo-600'
                        });
                        setLoading(false);
                        fetchData();
                    } else {
                        setLoading(false);
                    }
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) {
                         setCurrentUser({
                            id: session.user.id,
                            name: session.user.user_metadata.full_name || session.user.email,
                            role: 'Owner',
                            avatar: (session.user.user_metadata.full_name || 'U').substring(0, 2).toUpperCase(),
                            color: 'bg-indigo-600'
                        });
                        fetchData();
                    } else {
                        setCurrentUser(null);
                        setMeetings([]);
                        setTasks([]);
                        setDocs({});
                        setView('dashboard');
                    }
                });

                return () => subscription.unsubscribe();
            }, []);

            const handleGoogleLogin = async () => {
                const { error } = await supabase.auth.signInWithOAuth({ 
                    provider: 'google', 
                    options: { 
                        redirectTo: window.location.href,
                        // Request Calendar Access
                        scopes: 'https://www.googleapis.com/auth/calendar.readonly' 
                    } 
                });
                if (error) alert(error.message);
            };

            const handleEmailLogin = async (email) => {
                const { error } = await supabase.auth.signInWithOtp({
                    email,
                    options: { emailRedirectTo: window.location.href }
                });
                if (error) alert(error.message);
            };

            const handleLogout = async () => {
                try {
                    await supabase.auth.signOut();
                } catch (error) {
                    console.error("Sign out error:", error);
                } finally {
                    setSession(null);
                    setCurrentUser(null);
                    setMeetings([]);
                    setTasks([]);
                    setDocs({});
                    setView('dashboard');
                    setSelectedMeetingId(null);
                }
            };

            const fetchData = async () => {
                setDbStatus('connecting');
                try {
                    const { error: checkError } = await supabase.from('meetings').select('id').limit(1);
                    if (checkError && (checkError.code === 'PGRST205' || checkError.code === '42P01')) {
                        throw { code: 'TABLE_MISSING' };
                    }

                    const { data: m, error: mErr } = await supabase.from('meetings').select('*');
                    const { data: t, error: tErr } = await supabase.from('tasks').select('*');
                    const { data: d, error: dErr } = await supabase.from('docs').select('*');

                    if (mErr || tErr || dErr) throw new Error("Fetch failed");

                    const parsedM = m.map(x => ({ ...x, participants: typeof x.participants === 'string' ? JSON.parse(x.participants) : x.participants || [] }));
                    const parsedT = t.map(x => ({ ...x, meetingId: x.meeting_id }));
                    const docsMap = {}; d.forEach(x => docsMap[x.id] = x.content);

                    setMeetings(parsedM);
                    setTasks(parsedT);
                    setDocs(docsMap);
                    setDbStatus(parsedM.length ? 'connected' : 'empty');

                } catch (err) {
                    if (err.code === 'TABLE_MISSING') {
                        setDbStatus('setup_required');
                    } else {
                        console.error(err);
                        setDbStatus('error');
                        setErrorMsg(err.message);
                    }
                }
            };

            // REAL GOOGLE CALENDAR SYNC
            const handleSync = async () => {
                if (!session?.provider_token) {
                    alert("Sync Unavailable: Missing Google Access Token.\n\nExplanation: This usually happens if you refreshed the page after logging in (tokens are not persisted for security).\n\nSolution: Please 'Log Out' and 'Sign in with Google' again immediately before syncing.");
                    return;
                }

                setIsSyncing(true);
                try {
                    // Fetch range
                    let timeMin = new Date().toISOString();
                    if (syncRange === 'past_month') {
                        const d = new Date();
                        d.setDate(d.getDate() - 30);
                        timeMin = d.toISOString();
                    }

                    const resp = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?maxResults=50&orderBy=startTime&singleEvents=true&timeMin=${timeMin}`, {
                        headers: { Authorization: `Bearer ${session.provider_token}` }
                    });
                    
                    if (!resp.ok) {
                        const errData = await resp.json();
                        if (errData.error?.message?.includes("Google Calendar API has not been used")) {
                             throw new Error("API_DISABLED");
                        }
                        throw new Error(errData.error?.message || "Failed to fetch from Google");
                    }

                    const data = await resp.json();
                    
                    if (data.items.length === 0) {
                        alert("Connection successful, but 0 events found in your primary Google Calendar for this range.");
                        setIsSyncing(false);
                        return;
                    }

                    // Transform & Save
                    for (const event of data.items) {
                        const mId = event.id;
                        const docId = `doc_${event.id}`;
                        const start = new Date(event.start.dateTime || event.start.date);
                        const offset = start.getTimezoneOffset() * 60000;
                        const dateStr = new Date(start.getTime() - offset).toISOString().split('T')[0];
                        
                        // Parse description for tasks
                        const description = event.description || '';
                        // Regex to find lines starting with [ ] or - [ ] or TODO:
                        const taskRegex = /(?:^|\n)(?:-? ?\[ ?\]|TODO:|Task:)\s*(.+)/gi;
                        let match;
                        while ((match = taskRegex.exec(description)) !== null) {
                            const taskText = match[1].trim();
                            if (taskText) {
                                // Create task if it doesn't exist (basic check)
                                // Ideally we'd have a unique ID for the task, but here we generate one
                                const taskId = `t_${event.id}_${taskText.substring(0, 5).replace(/\s/g, '')}`;
                                await supabase.from('tasks').upsert({
                                    id: taskId,
                                    meeting_id: mId,
                                    text: taskText,
                                    assignee: currentUser.id,
                                    done: false
                                }, { ignoreDuplicates: true }); // Prevent overwriting status if exists
                            }
                        }

                        await supabase.from('meetings').upsert({
                            id: mId,
                            title: event.summary || '(No Title)',
                            date: dateStr,
                            time: start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            duration: '1h',
                            participants: [currentUser.id],
                            doc_id: docId,
                            google_calendar_id: event.id,
                            synced: true,
                            platform: 'Google Calendar'
                        });
                        
                        await supabase.from('docs').upsert({ 
                            id: docId, 
                            content: `<h1>${event.summary}</h1><p>${description || 'No description provided.'}</p>` 
                        }, { onConflict: 'id', ignoreDuplicates: true });
                    }
                    
                    await fetchData();
                    alert(`Successfully synced ${data.items.length} events from Google Calendar!`);

                } catch (e) {
                    console.error(e);
                    if (e.message === "API_DISABLED") {
                        alert("Action Required: Google Calendar API is not enabled.\n\n1. Go to Google Cloud Console (console.cloud.google.com)\n2. Select your project\n3. Go to 'APIs & Services' > 'Library'\n4. Search for 'Google Calendar API' and click ENABLE.\n5. Wait 2 minutes and try again.");
                    } else {
                        alert("Sync Error: " + e.message);
                    }
                } finally {
                    setIsSyncing(false);
                }
            };

            const clearDatabase = async () => {
                if (!confirm("Are you sure? This will delete ALL meetings, tasks, and notes from your database. This cannot be undone.")) return;
                
                try {
                    const { error: tErr } = await supabase.from('tasks').delete().neq('id', '0'); 
                    const { error: dErr } = await supabase.from('docs').delete().neq('id', '0');
                    const { error: mErr } = await supabase.from('meetings').delete().neq('id', '0');
                    
                    if (tErr || dErr || mErr) throw new Error("Deletion partially failed");
                    
                    await fetchData();
                    alert("Database cleared.");
                } catch (e) {
                    alert("Error clearing DB: " + e.message);
                }
            };

            const handleDocSave = async (content) => {
                if(!selectedMeetingId) return;
                const m = meetings.find(x => x.id === selectedMeetingId);
                setDocs(prev => ({ ...prev, [m.docId]: content }));
                if (dbStatus === 'connected' || dbStatus === 'empty') {
                    await supabase.from('docs').upsert({ id: m.docId, content });
                }
            };

            const handleTaskToggle = async (taskId, currentDone) => {
                setTasks(prev => prev.map(t => t.id === taskId ? { ...t, done: !currentDone } : t));
                if (dbStatus === 'connected') {
                    await supabase.from('tasks').update({ done: !currentDone }).eq('id', taskId);
                }
            };

            // Filter Logic
            const myMeetings = meetings.filter(m => {
                if (!currentUser) return false;
                const isParticipant = m.participants && Array.isArray(m.participants) && m.participants.includes(currentUser.id);
                // Filter by selected date
                // Note: syncing past month will load data, but this filter might hide it if selectedDate is today
                // We should probably allow showing all if range is different or just filter by day.
                // Let's keep date filter for "My Meetings" view strict to selectedDate
                const isDateMatch = m.date === selectedDate;
                return isParticipant && isDateMatch;
            });

            // Flatten all tasks for the "My Tasks" view
            const myTasks = tasks.filter(t => true);

            if (loading) return null;

            if (!session) return <LoginScreen onLogin={handleGoogleLogin} onEmailLogin={handleEmailLogin} />;

            // --- Dashboard View ---
            if (view === 'dashboard') {
                return (
                    <div className="flex flex-col h-screen bg-gray-50">
                        <AppHeader 
                            currentUser={currentUser} 
                            onLogout={handleLogout} 
                            onSync={handleSync}
                            onClear={clearDatabase}
                            dbStatus={dbStatus}
                            isSyncing={isSyncing}
                            syncRange={syncRange}
                            setSyncRange={setSyncRange}
                        />

                        <main className="flex-1 overflow-y-auto p-6">
                            <div className="max-w-5xl mx-auto">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900">
                                            {dashboardViewMode === 'meetings' ? 'My Meetings' : 'My Tasks'}
                                        </h2>
                                        <p className="text-gray-500 text-sm mt-1">
                                            {currentUser.name} â€¢ {new Date(selectedDate).toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}
                                        </p>
                                    </div>
                                    <div className="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                                        <div className="flex items-center space-x-1 bg-white p-1 rounded-lg border border-gray-200 shadow-sm w-full sm:w-auto">
                                             <button
                                                onClick={() => setDashboardViewMode('meetings')}
                                                className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'meetings' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}`}
                                             >
                                                Meetings
                                             </button>
                                             <button
                                                onClick={() => setDashboardViewMode('tasks')}
                                                className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'tasks' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}`}
                                             >
                                                Tasks
                                             </button>
                                        </div>
                                        
                                        <div className="relative w-full sm:w-auto">
                                            <input
                                                type="date"
                                                value={selectedDate}
                                                onChange={(e) => setSelectedDate(e.target.value)}
                                                className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            />
                                            <Icon name="Calendar" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none" />
                                        </div>
                                    </div>
                                </div>
                                
                                {dbStatus === 'setup_required' && (
                                    <div className="bg-red-50 border border-red-200 p-6 rounded-lg mb-6">
                                        <h3 className="font-bold text-red-900 mb-2">Database Missing Tables</h3>
                                        <p className="text-sm text-red-700 mb-4">Run this SQL in your Supabase Dashboard:</p>
                                        <div className="bg-gray-900 text-gray-100 p-3 rounded text-xs overflow-auto max-h-32 mb-4"><pre>{SQL_SETUP_INSTRUCTIONS}</pre></div>
                                        <button onClick={fetchData} className="bg-red-600 text-white px-4 py-2 rounded text-sm">Retry Connection</button>
                                    </div>
                                )}

                                {dashboardViewMode === 'meetings' ? (
                                    <>
                                        {myMeetings.length > 0 ? (
                                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                {myMeetings.map(m => <MeetingCard key={m.id} meeting={m} users={currentUser ? [currentUser, ...MOCK_DB_USERS] : MOCK_DB_USERS} onClick={() => { setSelectedMeetingId(m.id); setView('meeting'); }} />)}
                                            </div>
                                        ) : (
                                            <div className="text-center py-20 bg-white rounded-xl border border-dashed">
                                                <p className="text-gray-500">No meetings found for {selectedDate}.</p>
                                                {dbStatus === 'empty' && <p className="text-sm text-indigo-500 mt-2">Click "Sync" to load from Google.</p>}
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    /* Tasks View */
                                    <div className="space-y-3">
                                        {myTasks.length > 0 ? (
                                            myTasks.map(t => {
                                                const mtg = meetings.find(m => m.id === t.meetingId);
                                                return <TaskCard key={t.id} task={t} meetingTitle={mtg ? mtg.title : 'Unknown Meeting'} onToggle={handleTaskToggle} />;
                                            })
                                        ) : (
                                            <div className="text-center py-12 bg-white rounded-xl border border-dashed text-gray-500">
                                                No tasks found.
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                );
            }

            // --- Meeting View ---
            const m = meetings.find(x => x.id === selectedMeetingId);
            if (!m) return null;

            return (
                <div className="flex flex-col h-screen bg-white">
                    <AppHeader 
                        currentUser={currentUser} 
                        onLogout={handleLogout} 
                        dbStatus={dbStatus} 
                        onBack={() => setView('dashboard')}
                        title={m.title}
                    />
                    <div className="flex-1 flex overflow-hidden">
                        <div className="flex-1 p-4 bg-gray-100">
                            <GoogleDocEditor title={m.title} docContent={docs[m.docId]} onSave={handleDocSave} />
                        </div>
                        {/* ENABLED TASK MANAGER */}
                        <TaskManager 
                            tasks={tasks.filter(t => t.meetingId === m.id)}
                            users={currentUser ? [currentUser, ...MOCK_DB_USERS] : MOCK_DB_USERS}
                            currentUserId={currentUser ? currentUser.id : null}
                            onToggle={handleTaskToggle}
                            onAdd={(mId, text, assignee) => {
                                const newId = `t_${Date.now()}`;
                                setTasks(prev => [...prev, { id: newId, meetingId: mId, text, assignee, done: false }]);
                                if (dbStatus === 'connected') {
                                    supabase.from('tasks').insert({ id: newId, meeting_id: mId, text, assignee, done: false }).then();
                                }
                            }}
                            meetingId={m.id}
                        />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
