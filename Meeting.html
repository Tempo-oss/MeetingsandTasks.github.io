<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetingMate - Collaborative Meeting Tool</title>
    
    <!-- Robust Favicon: Uses a data URI to prevent 404 network errors for favicon.ico -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">

    <!-- Global Error Handler: Catches script loading errors immediately -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="background-color: #FEF2F2; color: #991B1B; padding: 2rem; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 48px; height: 48px; margin-bottom: 1rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Startup Error</h2>
                        <p style="margin-bottom: 1rem;">The application failed to start.</p>
                        <div style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #FCA5A5; text-align: left; max-width: 600px; overflow-x: auto;">
                            <code style="font-family: monospace;">${msg}</code>
                        </div>
                        <p style="margin-top: 1.5rem; font-size: 0.875rem; color: #7F1D1D;">
                            Troubleshooting: Check your internet connection (CDNs must be reachable) and browser console.
                        </p>
                    </div>
                `;
            }
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Production versions) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .prose h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #111827; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; color: #374151; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose b { font-weight: 600; }
        .prose:focus { outline: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden">
    <!-- Initial Loading State -->
    <div id="root" class="h-full flex items-center justify-center">
        <div class="text-center text-gray-500 animate-pulse">
            <svg class="w-10 h-10 mx-auto mb-2 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Loading MeetingMate...</p>
        </div>
    </div>

    <script type="text/babel">
        // --- Dependency Check ---
        if (!window.React || !window.ReactDOM || !window.supabase) {
            throw new Error("Missing dependencies: React, ReactDOM, or Supabase failed to load. Check your network/ad-blocker.");
        }

        const { useState, useEffect, useRef } = React;

        // --- Configuration ---
        const SUPABASE_URL = 'https://yasoowbpyknuikdvlahz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_7upkUKZm8t5fQh9EwLVFbQ_DmnLAObn';
        
        // Initialize Supabase Client
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error("Supabase Init Error:", e);
            throw new Error("Failed to initialize Supabase client.");
        }

        // --- Icons ---
        const Icon = ({ name, className, ...props }) => {
            const icons = {
                Calendar: <path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm-13 0V2m12 2V2M3 10h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Clock: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm0-14v6l4 2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Video: <path d="m22 8-6 4 6 4V8Z M16 19h-4m-4 0H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Search: <path d="m21 21-4.3-4.3 M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Plus: <path d="M12 5v14M5 12h14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                ChevronLeft: <path d="m15 18-6-6 6-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8 M21 3v5h-5 M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16 M3 21v-5h5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Database: <path d="M3 5V19A9 3 0 0 0 21 19V5 M3 5A9 3 0 0 1 21 5 M3 5A9 3 0 0 0 21 5 M3 12A9 3 0 0 0 21 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                UploadCloud: <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242 M12 12v9 M16 16l-4-4-4 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                AlertCircle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9h2m-2 4h2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                CheckSquare: <path d="m9 11 3 3L22 4 M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                FileText: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M14 2v6h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Bold: <path d="M14 12a4 4 0 0 0 0-8H6v8 M15 20a4 4 0 0 0 0-8H6v8Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Italic: <path d="M19 4h-9M14 20H5M15 4L9 20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Underline: <path d="M6 4v6a6 6 0 0 0 12 0V4 M4 20h16" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Share2: <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Circle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                CheckCircle2: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9 2 2 4-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                Link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                X: <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="24" height="24" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    className={className}
                    {...props}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/>}
                </svg>
            );
        };

        // --- SQL Setup Reference ---
        const SQL_SETUP_INSTRUCTIONS = `
        -- Run these commands in your Supabase SQL Editor to enable full persistence:
        
        create table meetings (
            id text primary key,
            title text,
            date text,
            time text,
            duration text,
            participants jsonb, 
            doc_id text,
            google_calendar_id text,
            synced boolean,
            platform text
        );

        create table tasks (
            id text primary key,
            meeting_id text,
            text text,
            assignee text,
            done boolean
        );

        create table docs (
            id text primary key,
            content text
        );
        `;

        // --- Mock Data Constants ---
        const USERS = [
            { id: 'u1', name: 'Alice Chen', role: 'Product Manager', avatar: 'AC', color: 'bg-blue-500' },
            { id: 'u2', name: 'Bob Smith', role: 'Developer', avatar: 'BS', color: 'bg-green-500' },
            { id: 'u3', name: 'Charlie Kim', role: 'Designer', avatar: 'CK', color: 'bg-purple-500' },
            { id: 'u4', name: 'Dana Lee', role: 'VP Engineering', avatar: 'DL', color: 'bg-orange-500' },
        ];

        const SEED_MEETINGS = [
            {
                id: 'm1',
                title: 'Q3 Product Roadmap Review',
                date: '2023-10-25',
                time: '10:00 AM',
                duration: '1h',
                participants: ['u1', 'u2', 'u3', 'u4'],
                docId: 'd1',
                googleCalendarId: 'gcal_123',
                synced: true,
                platform: 'Google Meet'
            },
            {
                id: 'm2',
                title: 'Design Huddle: Dashboard',
                date: '2023-10-25',
                time: '02:00 PM',
                duration: '45m',
                participants: ['u1', 'u3'],
                docId: 'd2',
                googleCalendarId: 'gcal_124',
                synced: true,
                platform: 'Zoom'
            },
            {
                id: 'm3',
                title: 'Weekly Engineering Sync',
                date: '2023-10-26',
                time: '11:00 AM',
                duration: '1h',
                participants: ['u2', 'u4'],
                docId: 'd3',
                googleCalendarId: 'gcal_125',
                synced: true,
                platform: 'Google Meet'
            }
        ];

        const SEED_TASKS = [
            { id: 't1', meetingId: 'm1', text: 'Finalize Q3 scope document', assignee: 'u1', done: false },
            { id: 't2', meetingId: 'm1', text: 'Update Jira board with new epics', assignee: 'u2', done: true },
            { id: 't3', meetingId: 'm2', text: 'Create high-fidelity mockups', assignee: 'u3', done: false },
        ];

        const SEED_DOCS = {
            'd1': "<h1>Q3 Roadmap Review</h1><p><b>Attendees:</b> All Dept Heads</p><p>We discussed the primary goals for the upcoming quarter. The focus will be on:</p><ul><li>Performance improvements</li><li>Mobile app redesign</li><li>Customer retention features</li></ul><p><br>Action items were assigned to respective leads.</p>",
            'd2': "<h1>Design Huddle Notes</h1><p>Discussing the new dashboard layout. Need to ensure the color contrast meets accessibility standards.</p>",
            'd3': "<h1>Eng Sync</h1><p>Talking about the migration to the new database cluster.</p>"
        };

        // --- Components ---

        const UserAvatar = ({ user, size = 'md' }) => {
            const sizeClasses = {
                sm: 'w-6 h-6 text-xs',
                md: 'w-8 h-8 text-sm',
                lg: 'w-10 h-10 text-base',
                xl: 'w-12 h-12 text-lg'
            };
            if (!user) return null;
            return (
                <div className={`${sizeClasses[size]} ${user.color} rounded-full flex items-center justify-center text-white font-medium ring-2 ring-white select-none`} title={user.name}>
                    {user.avatar}
                </div>
            );
        };

        const MeetingCard = ({ meeting, users, onClick }) => {
            const participantIds = Array.isArray(meeting.participants) ? meeting.participants : [];
            const attendees = participantIds.map(id => users.find(u => u.id === id)).filter(Boolean);
            
            return (
                <div onClick={onClick} className="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-lg hover:border-indigo-200 transition-all cursor-pointer group">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <h3 className="font-semibold text-gray-900 group-hover:text-indigo-600 transition-colors">{meeting.title}</h3>
                            <div className="flex items-center text-gray-500 text-sm mt-1 space-x-3">
                                <span className="flex items-center"><Icon name="Clock" className="w-3 h-3 mr-1" /> {meeting.time}</span>
                                <span className="flex items-center"><Icon name="Video" className="w-3 h-3 mr-1" /> {meeting.platform}</span>
                            </div>
                        </div>
                        {meeting.synced && (
                            <div className="bg-blue-50 text-blue-600 p-1.5 rounded-full" title="Synced from Google Calendar">
                                <Icon name="Calendar" className="w-4 h-4" />
                            </div>
                        )}
                    </div>
                    <div className="flex justify-between items-center mt-4">
                        <div className="flex -space-x-2">
                            {attendees.map(user => (
                                <UserAvatar key={user.id} user={user} size="sm" />
                            ))}
                        </div>
                        <div className="flex items-center text-gray-400 text-sm space-x-1 group-hover:text-indigo-500 transition-colors">
                            <span>Open Notes</span>
                            <Icon name="ChevronLeft" className="w-4 h-4 rotate-180" />
                        </div>
                    </div>
                </div>
            );
        };

        const GoogleDocEditor = ({ docContent, title, onSave }) => {
            const [localContent, setLocalContent] = useState(docContent);
            const timeoutRef = useRef(null);

            useEffect(() => {
                setLocalContent(docContent || '<p class="text-gray-400 italic">Start typing your notes here...</p>');
            }, [docContent]);

            const handleChange = (e) => {
                const newContent = e.currentTarget.innerHTML;
                if (timeoutRef.current) clearTimeout(timeoutRef.current);
                timeoutRef.current = setTimeout(() => {
                    onSave(newContent);
                }, 1000);
            };

            return (
                <div className="flex flex-col h-full bg-gray-100 rounded-lg overflow-hidden border border-gray-300">
                    <div className="bg-white border-b border-gray-200 p-2 flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                            <div className="bg-blue-600 p-1.5 rounded text-white">
                                <Icon name="FileText" className="w-5 h-5" />
                            </div>
                            <div>
                                <h3 className="text-sm font-medium text-gray-800 leading-tight truncate max-w-[150px] sm:max-w-xs">{title}</h3>
                                <div className="flex space-x-2 text-xs text-gray-500 mt-0.5">
                                    <span className="hover:bg-gray-100 px-1 rounded cursor-pointer">File</span>
                                    <span className="hover:bg-gray-100 px-1 rounded cursor-pointer">Edit</span>
                                    <span className="hover:bg-gray-100 px-1 rounded cursor-pointer">View</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center space-x-2">
                             <div className="flex items-center space-x-1 border-r border-gray-300 pr-2 mr-2 hidden sm:flex">
                                <button className="p-1 hover:bg-gray-100 rounded text-gray-600"><Icon name="Bold" className="w-4 h-4" /></button>
                                <button className="p-1 hover:bg-gray-100 rounded text-gray-600"><Icon name="Italic" className="w-4 h-4" /></button>
                                <button className="p-1 hover:bg-gray-100 rounded text-gray-600"><Icon name="Underline" className="w-4 h-4" /></button>
                             </div>
                             <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-full text-sm font-medium flex items-center space-x-2 transition-colors">
                                <Icon name="Share2" className="w-3 h-3" />
                                <span>Share</span>
                             </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 sm:p-8 flex justify-center">
                        <div className="bg-white w-full max-w-3xl shadow-sm min-h-full p-8 sm:p-12 outline-none">
                            <div 
                                className="prose prose-indigo max-w-none focus:outline-none min-h-[500px]"
                                contentEditable
                                suppressContentEditableWarning
                                dangerouslySetInnerHTML={{ __html: localContent }}
                                onInput={handleChange}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        const TaskManager = ({ tasks, users, onToggle, onAdd, meetingId }) => {
            const [newTaskText, setNewTaskText] = useState('');
            const [assignee, setAssignee] = useState(users[0].id);

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newTaskText.trim()) return;
                onAdd(meetingId, newTaskText, assignee);
                setNewTaskText('');
            };

            const activeTasks = tasks.filter(t => !t.done);
            const completedTasks = tasks.filter(t => t.done);

            return (
                <div className="h-full flex flex-col bg-white border-l border-gray-200 w-80 shrink-0">
                    <div className="p-4 border-b border-gray-200 bg-gray-50">
                        <h2 className="font-semibold text-gray-800 flex items-center">
                            <Icon name="CheckSquare" className="w-4 h-4 mr-2 text-indigo-600" />
                            Action Items
                        </h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        <div className="space-y-3">
                            <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider">To Do</h3>
                            {activeTasks.length === 0 && <p className="text-sm text-gray-400 italic">No open tasks.</p>}
                            {activeTasks.map(task => {
                                const assignedUser = users.find(u => u.id === task.assignee);
                                return (
                                    <div key={task.id} className="group bg-white border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-all">
                                        <div className="flex items-start space-x-3">
                                            <button onClick={() => onToggle(task.id, !task.done)} className="mt-0.5 text-gray-400 hover:text-green-600 transition-colors">
                                                <Icon name="Circle" className="w-5 h-5" />
                                            </button>
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-800">{task.text}</p>
                                                <div className="mt-2 flex items-center justify-between">
                                                    <div className="flex items-center space-x-1.5 bg-gray-100 px-2 py-0.5 rounded-full">
                                                        <UserAvatar user={assignedUser} size="xs" />
                                                        <span className="text-xs text-gray-600">{assignedUser ? assignedUser.name.split(' ')[0] : 'Unassigned'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        {completedTasks.length > 0 && (
                            <div className="space-y-3 pt-4 border-t border-gray-100">
                                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Completed</h3>
                                {completedTasks.map(task => (
                                    <div key={task.id} className="flex items-center space-x-3 p-2 opacity-60">
                                        <button onClick={() => onToggle(task.id, !task.done)} className="text-green-600">
                                            <Icon name="CheckCircle2" className="w-5 h-5" />
                                        </button>
                                        <span className="text-sm text-gray-500 line-through">{task.text}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="p-4 border-t border-gray-200 bg-gray-50">
                        <form onSubmit={handleAdd}>
                            <input type="text" placeholder="New task..." className="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 mb-2 p-2 border" value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} />
                            <div className="flex items-center space-x-2">
                                <select className="flex-1 text-sm border-gray-300 rounded-md shadow-sm border p-1.5" value={assignee} onChange={(e) => setAssignee(e.target.value)}>
                                    {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                </select>
                                <button type="submit" disabled={!newTaskText.trim()} className="bg-indigo-600 text-white p-1.5 rounded-md hover:bg-indigo-700 disabled:opacity-50">
                                    <Icon name="Plus" className="w-5 h-5" />
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
            const [currentUser, setCurrentUser] = useState(USERS[0]);
            const [view, setView] = useState('dashboard');
            const [selectedMeetingId, setSelectedMeetingId] = useState(null);
            
            // App State
            const [meetings, setMeetings] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [docs, setDocs] = useState({});
            const [isSyncing, setIsSyncing] = useState(false);
            const [dbStatus, setDbStatus] = useState('connecting'); // 'connecting' | 'connected' | 'error' | 'empty' | 'local'
            const [errorMsg, setErrorMsg] = useState('');
            const [showSql, setShowSql] = useState(true);

            // Fetch Data
            const fetchData = async () => {
                if (!supabase) {
                    setDbStatus('error');
                    setErrorMsg('Supabase client failed to initialize');
                    return;
                }
                
                setDbStatus('connecting');
                try {
                    const { data: dbMeetings, error: mError } = await supabase.from('meetings').select('*');
                    if (mError) {
                        if (mError.code === 'PGRST205' || mError.code === '42P01') { // 42P01 is Postgres for "undefined table"
                            throw { code: 'TABLE_MISSING', message: 'Tables not found in Supabase' };
                        }
                        throw mError;
                    }
                    
                    const { data: dbTasks, error: tError } = await supabase.from('tasks').select('*');
                    if (tError) throw tError;

                    const { data: dbDocs, error: dError } = await supabase.from('docs').select('*');
                    if (dError) throw dError;

                    // Parse Data
                    const parsedMeetings = dbMeetings.map(m => ({
                        ...m,
                        participants: typeof m.participants === 'string' ? JSON.parse(m.participants) : m.participants || []
                    }));

                    const parsedTasks = dbTasks.map(t => ({
                        id: t.id,
                        meetingId: t.meeting_id,
                        text: t.text,
                        assignee: t.assignee,
                        done: t.done
                    }));

                    const docsMap = {};
                    dbDocs.forEach(d => { docsMap[d.id] = d.content; });

                    setMeetings(parsedMeetings);
                    setTasks(parsedTasks);
                    setDocs(docsMap);
                    
                    if (parsedMeetings.length === 0) {
                        setDbStatus('empty'); // Connected but no data
                    } else {
                        setDbStatus('connected');
                    }
                } catch (err) {
                    
                    // Fallback logic for missing tables
                    if (err.code === 'TABLE_MISSING' || err.message?.includes('not found')) {
                        console.warn("Falling back to local data due to missing Supabase tables.");
                        // Load Seeds immediately
                        const parsedMeetings = SEED_MEETINGS.map(m => ({
                             ...m,
                             participants: typeof m.participants === 'string' ? JSON.parse(m.participants) : m.participants || []
                        }));
                        setMeetings(parsedMeetings);
                        setTasks(SEED_TASKS);
                        setDocs(SEED_DOCS);
                        setDbStatus('local');
                    } else {
                        console.error("Supabase Error:", err);
                        setDbStatus('error');
                        setErrorMsg(err.message || "Unknown connection error");
                    }
                }
            };

            useEffect(() => {
                fetchData();
            }, []);

            // Helper to populate DB
            const seedDatabase = async () => {
                if (dbStatus === 'local') {
                    alert('Cannot seed. Tables are missing. Run the SQL setup script shown on the dashboard.');
                    return;
                }
                try {
                    setIsSyncing(true);
                    // Seed Meetings
                    for (const m of SEED_MEETINGS) {
                        await supabase.from('meetings').upsert({
                            id: m.id, title: m.title, date: m.date, time: m.time, duration: m.duration,
                            participants: m.participants, doc_id: m.docId, google_calendar_id: m.googleCalendarId,
                            synced: m.synced, platform: m.platform
                        });
                    }
                    // Seed Tasks
                    for (const t of SEED_TASKS) {
                        await supabase.from('tasks').upsert({
                            id: t.id, meeting_id: t.meetingId, text: t.text, assignee: t.assignee, done: t.done
                        });
                    }
                    // Seed Docs
                    for (const [id, content] of Object.entries(SEED_DOCS)) {
                        await supabase.from('docs').upsert({ id: id, content: content });
                    }
                    await fetchData(); // Refresh local state
                    alert('Database seeded! Data loaded.');
                } catch (err) {
                    console.error("Seed Error:", err);
                    alert('Seeding failed: ' + err.message);
                } finally {
                    setIsSyncing(false);
                }
            };

            // Handlers
            const handleSync = () => {
                setIsSyncing(true);
                // Simulation of adding a new meeting from GCal
                setTimeout(async () => {
                    const newId = `m${Date.now()}`;
                    const newDocId = `d${Date.now()}`;
                    const newMeeting = {
                        id: newId, title: 'Emergency Bug Bash', date: '2023-10-27', time: '04:00 PM', duration: '1h',
                        participants: ['u1', 'u2'], docId: newDocId, googleCalendarId: 'gcal_new', synced: true, platform: 'Google Meet'
                    };
                    const newDocContent = "<h1>Emergency Bug Bash</h1><p>Sync triggered from Google Calendar.</p>";

                    // Update State
                    setMeetings(prev => [...prev, newMeeting]);
                    setDocs(prev => ({ ...prev, [newDocId]: newDocContent }));

                    // Update DB if connected
                    if (dbStatus === 'connected' || dbStatus === 'empty') {
                        await supabase.from('meetings').insert({
                            id: newId, title: newMeeting.title, date: newMeeting.date, time: newMeeting.time, duration: newMeeting.duration,
                            participants: newMeeting.participants, doc_id: newDocId, google_calendar_id: newMeeting.googleCalendarId,
                            synced: true, platform: newMeeting.platform
                        });
                        await supabase.from('docs').insert({ id: newDocId, content: newDocContent });
                    }
                    
                    setIsSyncing(false);
                }, 1500);
            };

            const handleTaskToggle = async (taskId, currentDone) => {
                setTasks(prev => prev.map(t => t.id === taskId ? { ...t, done: !currentDone } : t)); // Optimistic
                if (dbStatus === 'connected' || dbStatus === 'empty') {
                    await supabase.from('tasks').update({ done: !currentDone }).eq('id', taskId);
                }
            };

            const handleAddTask = async (meetingId, text, assigneeId) => {
                const newId = `t${Date.now()}`;
                const newTask = { id: newId, meetingId, text, assignee: assigneeId, done: false };
                setTasks(prev => [...prev, newTask]); // Optimistic
                if (dbStatus === 'connected' || dbStatus === 'empty') {
                    await supabase.from('tasks').insert({
                        id: newId, meeting_id: meetingId, text, assignee: assigneeId, done: false
                    });
                }
            };

            const handleDocSave = async (content) => {
                if (!selectedMeetingId) return;
                const meeting = meetings.find(m => m.id === selectedMeetingId);
                setDocs(prev => ({ ...prev, [meeting.docId]: content })); // Optimistic
                if (dbStatus === 'connected' || dbStatus === 'empty') {
                    await supabase.from('docs').upsert({ id: meeting.docId, content: content });
                }
            };

            // Logic
            const myMeetings = meetings.filter(m => m.participants && Array.isArray(m.participants) && m.participants.includes(currentUser.id));
            const activeMeeting = meetings.find(m => m.id === selectedMeetingId);

            // Render Utils
            const renderStatusBadge = () => {
                if (dbStatus === 'connected') return <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs font-medium border border-green-200 flex items-center gap-1"><Icon name="Database" className="w-3 h-3"/> Connected</span>;
                if (dbStatus === 'empty') return <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs font-medium border border-yellow-200 flex items-center gap-1"><Icon name="Database" className="w-3 h-3"/> Empty DB</span>;
                if (dbStatus === 'local') return <span className="bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs font-medium border border-gray-200 flex items-center gap-1"><Icon name="Database" className="w-3 h-3"/> Local Mode</span>;
                if (dbStatus === 'error') return <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-medium border border-red-200 flex items-center gap-1"><Icon name="AlertCircle" className="w-3 h-3"/> Error</span>;
                return <span className="bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs font-medium border border-gray-200 flex items-center gap-1"><Icon name="RefreshCw" className="w-3 h-3 animate-spin"/> Connecting...</span>;
            };

            return (
                <div className="flex flex-col h-screen">
                    {/* Navigation */}
                    <header className="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 sticky top-0 z-20 shrink-0">
                        <div className="flex items-center space-x-3">
                            <div className="bg-indigo-600 p-2 rounded-lg">
                                <Icon name="Calendar" className="text-white w-6 h-6" />
                            </div>
                            <h1 className="text-xl font-bold text-gray-800 tracking-tight hidden sm:block">SyncMeet</h1>
                            {renderStatusBadge()}
                        </div>
                        <div className="flex items-center space-x-6">
                            {(dbStatus === 'connected' || dbStatus === 'empty') && (
                                <div className="flex items-center space-x-3">
                                    <button onClick={seedDatabase} className="flex items-center space-x-2 text-sm font-medium text-gray-500 hover:text-indigo-600 transition-colors" title="Populate DB with sample data">
                                        <Icon name="UploadCloud" className="w-4 h-4" />
                                        <span className="hidden lg:inline">Seed DB</span>
                                    </button>
                                    <button onClick={handleSync} disabled={isSyncing} className={`flex items-center space-x-2 text-sm font-medium ${isSyncing ? 'text-indigo-600' : 'text-gray-600 hover:text-indigo-600'}`}>
                                        <Icon name="RefreshCw" className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                                        <span className="hidden sm:inline">{isSyncing ? 'Syncing...' : 'Sync Calendar'}</span>
                                    </button>
                                </div>
                            )}
                            {/* In local mode, still allow Sync to demonstrate logic */}
                             {dbStatus === 'local' && (
                                <button onClick={handleSync} disabled={isSyncing} className={`flex items-center space-x-2 text-sm font-medium ${isSyncing ? 'text-indigo-600' : 'text-gray-600 hover:text-indigo-600'}`}>
                                    <Icon name="RefreshCw" className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                                    <span className="hidden sm:inline">{isSyncing ? 'Syncing...' : 'Sync Calendar'}</span>
                                </button>
                             )}

                            <div className="h-6 w-px bg-gray-200 hidden sm:block"></div>
                            <div className="flex items-center space-x-3">
                                <div className="text-right hidden sm:block">
                                    <p className="text-sm font-medium text-gray-900">{currentUser.name}</p>
                                    <p className="text-xs text-gray-500">{currentUser.role}</p>
                                </div>
                                <div className="relative group cursor-pointer">
                                    <UserAvatar user={currentUser} size="lg" />
                                    <div className="absolute right-0 top-full mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-100 p-2 hidden group-hover:block z-50">
                                        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-2 py-1 mb-1">Switch User View</p>
                                        {USERS.map(u => (
                                            <button key={u.id} onClick={() => { setCurrentUser(u); setView('dashboard'); setSelectedMeetingId(null); }} 
                                                className={`w-full text-left flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50 transition-colors ${currentUser.id === u.id ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700'}`}>
                                                <UserAvatar user={u} size="sm" />
                                                <span className="text-sm">{u.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* View Switching */}
                    {view === 'dashboard' ? (
                        <main className="flex-1 overflow-y-auto p-6 sm:p-10 bg-gray-50">
                            <div className="max-w-6xl mx-auto">
                                <div className="flex items-center justify-between mb-8">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900">My Meetings</h2>
                                        <p className="text-gray-500 mt-1">Viewing calendar for {currentUser.name}</p>
                                    </div>
                                    <div className="flex space-x-3">
                                        <div className="relative">
                                            <Icon name="Search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                                            <input type="text" placeholder="Search meetings..." className="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                        </div>
                                    </div>
                                </div>

                                {/* Loading / Empty / Error States */}
                                {dbStatus === 'connecting' && <div className="text-center py-20"><Icon name="RefreshCw" className="w-10 h-10 animate-spin text-gray-300 mx-auto"/></div>}
                                
                                {dbStatus === 'error' && (
                                    <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                                        <Icon name="AlertCircle" className="w-10 h-10 text-red-400 mx-auto mb-2"/>
                                        <h3 className="text-lg font-medium text-red-800">Connection Failed</h3>
                                        <p className="text-red-600 mb-4">{errorMsg}</p>
                                    </div>
                                )}

                                {dbStatus === 'local' && showSql && (
                                    <div className="bg-indigo-50 border border-indigo-100 rounded-lg p-6 mb-8 relative">
                                        <button onClick={() => setShowSql(false)} className="absolute top-4 right-4 text-indigo-400 hover:text-indigo-700">
                                            <Icon name="X" className="w-5 h-5" />
                                        </button>
                                        <div className="flex items-start space-x-4">
                                            <div className="p-2 bg-indigo-100 rounded-lg shrink-0">
                                                <Icon name="Database" className="w-6 h-6 text-indigo-600" />
                                            </div>
                                            <div className="flex-1">
                                                <h3 className="text-lg font-semibold text-indigo-900">Supabase Tables Missing</h3>
                                                <p className="text-indigo-700 mt-1 mb-4 text-sm">
                                                    We've loaded local demo data so you can try the app. To enable real-time persistence, 
                                                    copy the SQL below and run it in your Supabase SQL Editor.
                                                </p>
                                                <div className="bg-gray-900 text-gray-100 p-4 rounded text-xs font-mono overflow-auto max-h-48 border border-gray-700 shadow-inner">
                                                    <pre>{SQL_SETUP_INSTRUCTIONS}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {dbStatus === 'empty' && (
                                    <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
                                        <Icon name="Database" className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                                        <h3 className="text-lg font-medium text-gray-900">Database is Empty</h3>
                                        <p className="text-gray-500 max-w-sm mx-auto mt-2 mb-4">Click "Seed DB" in the top bar to load initial data.</p>
                                        <button onClick={seedDatabase} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">Seed Database</button>
                                    </div>
                                )}

                                {(dbStatus === 'connected' || dbStatus === 'local') && myMeetings.length === 0 && (
                                    <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
                                        <Icon name="Calendar" className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                                        <h3 className="text-lg font-medium text-gray-900">No meetings for {currentUser.name}</h3>
                                        <p className="text-gray-500 mt-2">Try switching users.</p>
                                    </div>
                                )}

                                {/* Meeting Grid */}
                                {(dbStatus === 'connected' || dbStatus === 'local') && myMeetings.length > 0 && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {myMeetings.map(meeting => (
                                            <MeetingCard key={meeting.id} meeting={meeting} users={USERS} onClick={() => { setSelectedMeetingId(meeting.id); setView('meeting'); }} />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </main>
                    ) : (
                        /* Detail View */
                        <div className="flex-1 flex flex-col overflow-hidden bg-white">
                            <div className="border-b border-gray-200 p-4 flex items-center justify-between shrink-0">
                                <div className="flex items-center space-x-4">
                                    <button onClick={() => { setView('dashboard'); setSelectedMeetingId(null); }} className="p-2 hover:bg-gray-100 rounded-full text-gray-500 transition-colors">
                                        <Icon name="ChevronLeft" className="w-5 h-5" />
                                    </button>
                                    <div>
                                        <h2 className="text-lg font-bold text-gray-900 leading-tight">{activeMeeting?.title}</h2>
                                        <div className="flex items-center text-xs text-gray-500 mt-1 space-x-3">
                                            <span className="flex items-center"><Icon name="Calendar" className="w-3 h-3 mr-1" /> {activeMeeting?.date}</span>
                                            <span className="flex items-center"><Icon name="Clock" className="w-3 h-3 mr-1" /> {activeMeeting?.time}</span>
                                            <span className="flex items-center text-blue-600"><Icon name="Link" className="w-3 h-3 mr-1" /> {activeMeeting?.platform} Link</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="flex -space-x-2 mr-2">
                                        {activeMeeting?.participants.map(pid => (
                                            <UserAvatar key={pid} user={USERS.find(u => u.id === pid)} size="sm" />
                                        ))}
                                    </div>
                                    <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors shadow-sm hidden sm:block">
                                        Join Call
                                    </button>
                                </div>
                            </div>

                            <div className="flex-1 flex overflow-hidden">
                                <div className="flex-1 p-4 bg-gray-100 overflow-hidden">
                                    <GoogleDocEditor 
                                        title={`${activeMeeting?.title} - Notes`}
                                        docContent={docs[activeMeeting?.docId]} 
                                        onSave={handleDocSave}
                                    />
                                </div>
                                <TaskManager 
                                    meetingId={activeMeeting?.id}
                                    tasks={tasks.filter(t => t.meetingId === activeMeeting?.id)}
                                    users={USERS}
                                    onToggle={handleTaskToggle}
                                    onAdd={handleAddTask}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
