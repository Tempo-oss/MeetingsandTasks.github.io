<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MeetingMate - Collaborative Meeting Tool</title>

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React & ReactDOM -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    body { font-family: 'Inter', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .prose h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #111827; }
    .prose p { margin-bottom: 0.75rem; line-height: 1.6; color: #374151; }
    .prose:focus { outline: none; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden">

<div id="root" class="h-full flex items-center justify-center">
    <div class="text-center text-gray-500 animate-pulse">
        <p>Loading MeetingMate...</p>
    </div>
</div>

<script type="text/babel">

const { useState, useEffect, useRef } = React;

// --- Supabase Config ---
const SUPABASE_URL = 'https://yasoowbpyknuikdvlahz.supabase.co';
const SUPABASE_KEY = 'sb_publishable_7upkUKZm8t5fQh9EwLVFbQ_DmnLAObn';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- Demo Users ---
const DEMO_USERS = [
    { id: 'u1', name: 'Alice Chen', role: 'PM', avatar: 'AC', color: 'bg-blue-500' },
    { id: 'u2', name: 'Bob Smith', role: 'Dev', avatar: 'BS', color: 'bg-green-500' },
    { id: 'u3', name: 'Charlie Kim', role: 'Designer', avatar: 'CK', color: 'bg-purple-500' },
    { id: 'u4', name: 'Dana Lee', role: 'VP Eng', avatar: 'DL', color: 'bg-orange-500' },
];

const SEED_MEETINGS = [
    { id: 'm1', title: 'Q3 Product Roadmap', date: '2023-10-25', time: '10:00 AM', duration: '1h', participants: ['u1','u2','u3','u4'], docId:'d1', synced:true, platform:'Google Meet' },
    { id: 'm2', title: 'Design Huddle', date: '2023-10-25', time: '02:00 PM', duration: '45m', participants: ['u1','u3'], docId:'d2', synced:true, platform:'Zoom' },
    { id: 'm3', title: 'Weekly Engineering', date: '2023-10-26', time: '11:00 AM', duration: '1h', participants: ['u2','u4'], docId:'d3', synced:true, platform:'Google Meet' }
];

const SEED_TASKS = [
    { id:'t1', meetingId:'m1', text:'Finalize Q3 scope', assignee:'u1', done:false },
    { id:'t2', meetingId:'m1', text:'Update Jira', assignee:'u2', done:true },
];

const SEED_DOCS = {
    d1: "<h1>Q3 Roadmap</h1><p>Goals for the quarter...</p>",
    d2: "<h1>Design Notes</h1><p>Accessibility standards...</p>",
    d3: "<h1>Eng Sync</h1><p>Migration plan...</p>"
};

// --- Simple Icon Component ---
const Icon = ({ name, className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" className={className}>
        {name === 'Calendar' && <path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm-13 0V2m12 2V2M3 10h18" stroke="currentColor" strokeWidth="2"/>}
        {name === 'LogOut' && <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" stroke="currentColor" strokeWidth="2"/>}
    </svg>
);

// --- User Avatar ---
const UserAvatar = ({ user, size='md' }) => {
    const sizeClasses = { sm:'w-6 h-6 text-xs', md:'w-8 h-8 text-sm', lg:'w-10 h-10 text-base' };
    if (!user) return null;
    return (
        <div className={`${sizeClasses[size]} ${user.color || 'bg-indigo-600'} rounded-full flex items-center justify-center text-white font-medium ring-2 ring-white select-none uppercase`} title={user.name}>
            {user.avatar || user.name.substring(0,2)}
        </div>
    );
};

// --- AppHeader ---
const AppHeader = ({ currentUser, onLogout, dbStatus, isDemo, onSeed, onBack, title }) => (
    <header className="bg-white border-b h-16 flex items-center justify-between px-4 sm:px-6 sticky top-0 z-20">
        <div className="flex items-center space-x-3">
            {onBack && <button onClick={onBack} className="p-1.5 hover:bg-gray-100 rounded-full text-gray-500"><Icon name="Calendar" className="w-5 h-5"/></button>}
            <h1 className="font-bold text-gray-800 text-lg truncate">{title || 'MeetingMate'}</h1>
            {isDemo && <span className="bg-orange-100 text-orange-700 text-[10px] uppercase font-bold px-2 py-0.5 rounded-full">Demo</span>}
            {!isDemo && dbStatus==='connected' && <span className="bg-green-100 text-green-700 text-[10px] uppercase font-bold px-2 py-0.5 rounded-full">Live</span>}
            {dbStatus==='setup_required' && <span className="bg-red-100 text-red-700 text-[10px] uppercase font-bold px-2 py-0.5 rounded-full">DB Setup</span>}
        </div>
        <div className="flex items-center space-x-3">
            {onSeed && <button onClick={onSeed} className="text-indigo-600 hover:text-indigo-800 text-sm flex items-center">Seed</button>}
            <div className="flex items-center space-x-2">
                <UserAvatar user={currentUser} size="sm"/>
                <span className="text-sm font-medium text-gray-700">{currentUser.name}</span>
                <button onClick={onLogout} className="text-gray-500 hover:text-red-600"><Icon name="LogOut" className="w-5 h-5"/></button>
            </div>
        </div>
    </header>
);

// --- Login Screen ---
const LoginScreen = ({ onLogin, onEmailLogin, onDemo }) => {
    const [email, setEmail] = useState(''); const [sent,setSent]=useState(false);
    const handleMagicLink = e => { e.preventDefault(); if(email){ onEmailLogin(email); setSent(true); } };
    return (
        <div className="h-full flex items-center justify-center bg-gray-50 p-4">
            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                    <Icon name="Calendar" className="w-8 h-8 text-indigo-600"/>
                </div>
                <h1 className="text-2xl font-bold text-gray-900 mb-2">Welcome to MeetingMate</h1>
                <p className="text-gray-500 mb-8">Collaborate on meeting notes, track tasks, and sync with your team.</p>
                <button onClick={onLogin} className="w-full flex items-center justify-center space-x-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-lg transition-colors mb-6">
                    <span>Sign in with Google</span>
                </button>
                {!sent ? (
                    <form onSubmit={handleMagicLink} className="mb-6 space-y-3">
                        <input type="email" placeholder="name@example.com" className="w-full px-4 py-2 border rounded-lg" value={email} onChange={e=>setEmail(e.target.value)}/>
                        <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg">Send Magic Link</button>
                    </form>
                ) : (
                    <div className="mb-6 bg-green-50 text-green-700 p-3 rounded-lg text-sm">Check your email for the login link!</div>
                )}
                <button onClick={onDemo} className="text-indigo-600 font-medium text-sm hover:underline">Try Demo Mode</button>
            </div>
        </div>
    );
};

// --- Meeting Card ---
const MeetingCard = ({ meeting, users, onClick }) => {
    const attendees = (meeting.participants || []).map(id => users.find(u=>u.id===id)||{id,name:'Guest',avatar:'G',color:'bg-gray-400'}).slice(0,4);
    return (
        <div onClick={onClick} className="bg-white rounded-xl border p-5 hover:shadow-lg cursor-pointer">
            <h3 className="font-semibold">{meeting.title}</h3>
            <div className="flex mt-2 space-x-2">{attendees.map(u=><UserAvatar key={u.id} user={u} size="sm"/>)}</div>
        </div>
    );
};

// --- Google Doc Editor ---
const GoogleDocEditor = ({ docContent, title, onSave }) => {
    const [localContent,setLocalContent]=useState(docContent); const timeoutRef=useRef(null);
    useEffect(()=>{ setLocalContent(docContent || '<p class="text-gray-400 italic">Start typing...</p>'); },[docContent]);
    const handleChange=e=>{ const c=e.currentTarget.innerHTML; if(timeoutRef.current) clearTimeout(timeoutRef.current); timeoutRef.current=setTimeout(()=>onSave(c),1000); };
    return (
        <div className="flex flex-col h-full bg-gray-100 rounded-lg border">
            <div className="bg-white border-b p-2"><h3>{title}</h3></div>
            <div className="flex-1 overflow-y-auto p-4">
                <div className="bg-white w-full min-h-full p-6" contentEditable suppressContentEditableWarning dangerouslySetInnerHTML={{__html:localContent}} onInput={handleChange}></div>
            </div>
        </div>
    );
};

// --- Main App ---
const App = () => {
    const [session,setSession]=useState(null), [isDemo,setIsDemo]=useState(false), [currentUser,setCurrentUser]=useState(null),
    [view,setView]=useState('dashboard'), [selectedMeetingId,setSelectedMeetingId]=useState(null),
    [meetings,setMeetings]=useState([]), [tasks,setTasks]=useState([]), [docs,setDocs]=useState({}), [dbStatus,setDbStatus]=useState('connecting'),
    [loading,setLoading]=useState(true);

    const fetchData=async()=>{
        setDbStatus('connecting');
        try{
            const {error:checkError}=await supabase.from('meetings').select('id').limit(1);
            if(checkError && (checkError.code==='PGRST205'||checkError.code==='42P01')) throw {code:'TABLE_MISSING'};
            const {data:m}=await supabase.from('meetings').select('*');
            const {data:t}=await supabase.from('tasks').select('*');
            const {data:d}=await supabase.from('docs').select('*');
            setMeetings(m.map(x=>({...x,participants:typeof x.participants==='string'?JSON.parse(x.participants):x.participants||[]})));
            setTasks(t.map(x=>({...x,meetingId:x.meeting_id})));
            const docsMap={}; d.forEach(x=>docsMap[x.id]=x.content); setDocs(docsMap);
            setDbStatus(m.length?'connected':'empty');
        } catch(err){
            if(err.code==='TABLE_MISSING') setDbStatus('setup_required');
            else setDbStatus('error');
        }
    };

    const seedDatabase=async()=>{
        for(const m of SEED_MEETINGS) await supabase.from('meetings').upsert(m);
        for(const t of SEED_TASKS) await supabase.from('tasks').upsert(t);
        for(const [id,content] of Object.entries(SEED_DOCS)) await supabase.from('docs').upsert({id,content});
        fetchData();
    };

    const handleGoogleLogin=async()=>{ await supabase.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.href}}); };
    const handleEmailLogin=async(email)=>{ await supabase.auth.signInWithOtp({email,options:{emailRedirectTo:window.location.href}}); };
    const handleLogout=async()=>{ await supabase.auth.signOut(); };
    const enterDemo=()=>{ setIsDemo(true); setCurrentUser(DEMO_USERS[0]); setMeetings(SEED_MEETINGS); setTasks(SEED_TASKS); setDocs(SEED_DOCS); setDbStatus('demo'); setView('dashboard'); };

    const handleDocSave=async(content)=>{ if(!selectedMeetingId) return; const m=meetings.find(x=>x.id===selectedMeetingId); setDocs(prev=>({...prev,[m.docId]:content})); if(dbStatus==='connected'||dbStatus==='empty') await supabase.from('docs').upsert({id:m.docId,content}); };

    useEffect(()=>{
        const initialize=async()=>{ const {data:{session}}=await supabase.auth.getSession(); setSession(session); if(session){ setCurrentUser({id:session.user.id,name:session.user.user_metadata.full_name||session.user.email,avatar:(session.user.user_metadata.full_name||'U').substring(0,2).toUpperCase(),color:'bg-indigo-600'}); fetchData(); } setLoading(false); };
        initialize();
        const {data:{subscription}}=supabase.auth.onAuthStateChange((_event,session)=>{ setSession(session); if(session){ setCurrentUser({id:session.user.id,name:session.user.user_metadata.full_name||session.user.email,avatar:(session.user.user_metadata.full_name||'U').substring(0,2).toUpperCase(),color:'bg-indigo-600'}); fetchData(); setIsDemo(false); } else { setCurrentUser(null); setIsDemo(false); setMeetings([]); setTasks([]); setDocs({}); setView('dashboard'); setSelectedMeetingId(null); setDbStatus('connecting'); } }); return()=>subscription.unsubscribe();
    },[]);

    const myMeetings=meetings.filter(m=>isDemo||currentUser?.id && m.participants?.includes(currentUser.id));

    if(loading) return null;
    if(!session&&!isDemo) return <LoginScreen onLogin={handleGoogleLogin} onEmailLogin={handleEmailLogin} onDemo={enterDemo}/>;

    if(view==='dashboard') return (
        <div className="flex flex-col h-screen bg-gray-50">
            <AppHeader currentUser={currentUser} onLogout={handleLogout} dbStatus={dbStatus} isDemo={isDemo} onSeed={seedDatabase}/>
            <main className="flex-1 overflow-y-auto p-6">
                <h2 className="text-2xl font-bold mb-4">Upcoming Meetings</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">{myMeetings.map(m=><MeetingCard key={m.id} meeting={m} users={isDemo?DEMO_USERS:[currentUser,...DEMO_USERS]} onClick={()=>{setSelectedMeetingId(m.id);setView('meeting');}}/>)}</div>
            </main>
        </div>
    );

    const m=meetings.find(x=>x.id===selectedMeetingId);
    if(!m) return null;

    return (
        <div className="flex flex-col h-screen bg-white">
            <AppHeader currentUser={currentUser} onLogout={handleLogout} dbStatus={dbStatus} isDemo={isDemo} onBack={()=>setView('dashboard')} title={m.title}/>
            <div className="flex-1 flex overflow-hidden">
                <div className="flex-1 p-4 bg-gray-100">
                    <GoogleDocEditor title={m.title} docContent={docs[m.docId]} onSave={handleDocSave}/>
                </div>
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>
</body>
</html>
